(function(){"use strict";var e={8880:function(e,t,i){var n=i(3751),s=i(641);const a={id:"app"};function o(e,t,i,n,o,r){const l=(0,s.g2)("router-view");return(0,s.uX)(),(0,s.CE)("div",a,[(0,s.bF)(l)])}var r={name:"App"},l=i(6262);const c=(0,l.A)(r,[["render",o]]);var d=c,h=i(5220),u=i(33);const p={class:"main-area"},g={class:"middle-area"},m={class:"theory-area"},k={class:"node-area"},f={key:0,class:"sidebar-area"};function y(e,t,i,n,a,o){const r=(0,s.g2)("Main"),l=(0,s.g2)("TheoryView"),c=(0,s.g2)("NodeView"),d=(0,s.g2)("InstanceContent"),h=(0,s.g2)("ConstructWidget"),y=(0,s.g2)("MemoWidget");return(0,s.uX)(),(0,s.CE)("div",{class:"combined-container",style:(0,u.Tr)(o.gridStyles)},[(0,s.Lk)("div",p,[(0,s.bF)(r,{ref:"mainComp","user-id":a.userId,onNodeSelected:o.handleNodeSelected,onShowInstance:o.handleShowInstance,onGraphUpdated:o.onGraphUpdated,onConstructClicked:o.onConstructClicked,onEdgeClicked:o.onEdgeClicked,onEdgeClickedName:o.onEdgeClickedName,onRefresh:o.onRefresh,onCloseInstance:t[0]||(t[0]=e=>a.showSidebar=!1)},null,8,["user-id","onNodeSelected","onShowInstance","onGraphUpdated","onConstructClicked","onEdgeClicked","onEdgeClickedName","onRefresh"])]),(0,s.Lk)("div",{class:"drag-handle",onMousedown:t[1]||(t[1]=(...e)=>o.startDrag&&o.startDrag(...e))},null,32),(0,s.Lk)("div",g,[(0,s.Lk)("div",m,[(0,s.bF)(l,{ref:"conceptComp","user-id":a.userId,"graph-version":a.graphVersion,selectedConstruct:a.selectedConstruct,"clicked-edge":a.clickedEdge,onConstructClicked:o.handleConceptClicked,onTriplesHighlight:o.handleTriples},null,8,["user-id","graph-version","selectedConstruct","clicked-edge","onConstructClicked","onTriplesHighlight"])]),(0,s.Lk)("div",k,[(0,s.bF)(c,{ref:"nodeComp","user-id":a.userId,name:a.selectedNodeName,"graph-version":a.graphVersion,edge:a.clickedEdgeName,onShowInstance:o.handleShowInstance,onConstructClicked:o.onConstructClicked,onEdgeClicked:o.onEdgeClicked,onEdgeClickedName:o.onEdgeClickedName,onCloseInstance:t[2]||(t[2]=e=>a.showSidebar=!1)},null,8,["user-id","name","graph-version","edge","onShowInstance","onConstructClicked","onEdgeClicked","onEdgeClickedName"])])]),a.showSidebar?((0,s.uX)(),(0,s.CE)("div",f,[(0,s.bF)(d,{"user-id":a.userId,instances:a.sidebarInstances,"current-index":a.currentIndex,"is-edit-mode":a.isEditMode,"category-options":e.$refs.mainComp?e.$refs.mainComp.constructs:[],onClose:t[3]||(t[3]=e=>a.showSidebar=!1),onPrevInstance:t[4]||(t[4]=e=>a.currentIndex>0&&a.currentIndex--),onNextInstance:t[5]||(t[5]=e=>a.currentIndex<a.sidebarInstances.length-1&&a.currentIndex++),onEditInstance:o.onEditInstance,onAddNewInstance:o.onAddNewInstance,onDeleteInstance:t[6]||(t[6]=e=>o.onDeleteInstance(e)),onSave:o.onSaveInstance,onCancelEdit:o.onCancelEdit},null,8,["user-id","instances","current-index","is-edit-mode","category-options","onEditInstance","onAddNewInstance","onSave","onCancelEdit"])])):(0,s.Q3)("",!0),(0,s.bF)(h),(0,s.bF)(y)],4)}const v={class:"main-container"},w={class:"header-bar"},C={class:"controls button-group"},x=["src"],L={key:0,class:"highlight-stats"},I={key:1,class:"validation-overlay"},E={class:"validation-errors"},b={class:"container"},N={class:"legend-wrapper"},$={id:"legend",ref:"MainLegendContainer",class:"legend-container",viewBox:"0 0 150 300",preserveAspectRatio:"xMinYMin meet"},S={class:"search-container"},_={key:0,class:"search-results"},A=["onClick"],z={id:"chart",ref:"chartContainer",class:"chart"},T={class:"zoom-container"},M={class:"zoom-controls"},R={class:"slider-wrapper"},X={class:"zoom-percentage"},U={class:"size-filter-container"},G={class:"filter-controls"},F={class:"slider-wrapper",style:{position:"relative"}},P={key:0,class:"filter-percent"},V=["min","max"];function D(e,t,i,a,o,r){return(0,s.uX)(),(0,s.CE)(s.FK,null,[(0,s.Lk)("div",v,[(0,s.Lk)("div",w,[t[11]||(t[11]=(0,s.Lk)("h3",{class:"page-title"},"Indicator View",-1)),(0,s.Lk)("div",C,[(0,s.Lk)("button",{onClick:t[0]||(t[0]=(...e)=>r.handleRefresh&&r.handleRefresh(...e)),class:"refresh-button"},[(0,s.Lk)("img",{src:o.RefreshIcon,class:"refresh-icon","aria-label":"Refresh"},null,8,x)])])]),o.showHighlightStats?((0,s.uX)(),(0,s.CE)("div",L,[(0,s.Lk)("p",null,(0,u.v_)(o.highlightedCount)+" / "+(0,u.v_)(o.totalNodeCount)+" ("+(0,u.v_)((o.highlightedCount/o.totalNodeCount*100).toFixed(2))+"%)",1)])):(0,s.Q3)("",!0),Object.keys(o.validationErrors).length>0?((0,s.uX)(),(0,s.CE)("div",I,[(0,s.Lk)("div",E,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(o.validationErrors,((e,t)=>((0,s.uX)(),(0,s.CE)("div",{key:t,class:"error-item"},[(0,s.Lk)("p",null,(0,u.v_)(e),1)])))),128)),(0,s.Lk)("button",{onClick:t[1]||(t[1]=(...e)=>r.clearValidationErrors&&r.clearValidationErrors(...e)),class:"close-button"},"关闭")])])):(0,s.Q3)("",!0),(0,s.Lk)("div",b,[(0,s.Lk)("div",N,[((0,s.uX)(),(0,s.CE)("svg",$,null,512)),(0,s.Lk)("div",S,[(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>o.searchQuery=e),onKeydown:t[3]||(t[3]=(0,n.jR)(((...e)=>r.handleSearch&&r.handleSearch(...e)),["enter"])),placeholder:"Search indicator...",class:"search-input"},null,544),[[n.Jo,o.searchQuery]]),o.searchResults.length>0?((0,s.uX)(),(0,s.CE)("div",_,[(0,s.Lk)("button",{onClick:t[4]||(t[4]=(...e)=>r.clearSearchResults&&r.clearSearchResults(...e)),class:"close-search-results"},"x"),(0,s.Lk)("ul",null,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(o.searchResults.slice(0,3),((e,t)=>((0,s.uX)(),(0,s.CE)("li",{key:t,onClick:t=>r.zoomToSearchResult(e)},(0,u.v_)(e.name),9,A)))),128))])])):(0,s.Q3)("",!0)])]),(0,s.Lk)("div",z,null,512)])]),(0,s.Lk)("div",T,[(0,s.Lk)("div",M,[(0,s.Lk)("button",{class:"zoom-btn",onClick:t[5]||(t[5]=(...e)=>r.decreaseZoom&&r.decreaseZoom(...e)),"aria-label":"Zoom out"},"−"),(0,s.Lk)("div",R,[(0,s.Lk)("div",X,(0,u.v_)(o.zoomPercent)+"%",1),(0,s.bo)((0,s.Lk)("input",{type:"range",min:"10",max:"1000","onUpdate:modelValue":t[6]||(t[6]=e=>o.zoomPercent=e),onInput:t[7]||(t[7]=(...e)=>r.updateZoom&&r.updateZoom(...e))},null,544),[[n.Jo,o.zoomPercent,void 0,{number:!0}]])]),(0,s.Lk)("button",{class:"zoom-btn",onClick:t[8]||(t[8]=(...e)=>r.increaseZoom&&r.increaseZoom(...e)),"aria-label":"Zoom in"},"＋")])]),(0,s.Lk)("div",U,[(0,s.Lk)("div",G,[t[12]||(t[12]=(0,s.Lk)("div",{class:"size-circle min"},null,-1)),(0,s.Lk)("div",F,[o.totalNodeCount?((0,s.uX)(),(0,s.CE)("div",P,(0,u.v_)(r.filterPercent),1)):(0,s.Q3)("",!0),(0,s.bo)((0,s.Lk)("input",{type:"range",min:r.minRadius,max:r.maxRadius,"onUpdate:modelValue":t[9]||(t[9]=e=>o.sizeThreshold=e),onInput:t[10]||(t[10]=(...e)=>r.onSizeFilterChange&&r.onSizeFilterChange(...e))},null,40,V),[[n.Jo,o.sizeThreshold,void 0,{number:!0}]])]),t[13]||(t[13]=(0,s.Lk)("div",{class:"size-circle max"},null,-1))])])],64)}i(4114),i(8992),i(4520),i(2577),i(3949),i(1454);var O=i(8939),H=i(4335);const K={baseURL:""};var W=K;function j(e,t,i){if(e.clickedNode&&e.clickedNode!==i)return void t.stopPropagation();e.pauseSimulation(),e.fixNodePosition(i),e.$emit("node-selected",i.name),e.clickedNode===i?(e.resetHighlightNode(i,e.mainGroup,[],(()=>{}),(()=>{})),e.clickedNode=null,e.highlightLocked=!1,e.$emit("construct-clicked",null)):(e.highlightOnlyNode(i),e.clickedNode=i,e.highlightLocked=!0,e.$emit("construct-clicked",i.construct)),e.selectedNodeName=i.name,e.selectedInstances=e.instances[i.id]||[],e.currentIndex=0,O.Ubm(".radial-menu").remove(),Y(e,i,1);const n={nodeName:e.selectedNodeName,instances:e.selectedInstances,isEditMode:!1,currentIndex:e.currentIndex};e.$emit("show-instance",n),setTimeout((()=>{Q(e,i)}),800),t.stopPropagation()}function Q(e,t){const n=t.size,s=["#BBE7FE","#FFD4DB"],a=[i(6883),i(6023)],o=O.JLW().innerRadius(n).outerRadius(n+15),r=[{startAngle:-Math.PI/2,endAngle:Math.PI/2,index:0},{startAngle:Math.PI/2,endAngle:3*Math.PI/2,index:1}],l=e.mainGroup.append("g").attr("class","radial-menu").attr("transform",`translate(${t.x}, ${t.y})`);l.selectAll(".menu-arc").data(r).enter().append("path").attr("class","menu-arc").attr("d",o).attr("fill",(e=>s[e.index])).style("fill-opacity",1).style("cursor","pointer").on("click",(e=>{e.stopPropagation()})),l.selectAll(".menu-icon").data(r).enter().append("image").attr("class","menu-icon").attr("xlink:href",(e=>a[e.index])).attr("width",10).attr("height",10).attr("x",(e=>{const[t]=o.centroid(e);return t-5})).attr("y",(e=>{const[,t]=o.centroid(e);return t-5})).on("click",((i,n)=>{i.stopPropagation(),O.Ubm(".radial-menu").remove();const s=n.index;0===s?(e.clickedNodeName=t.name,e.addNewNode(),Y(e,t,1.5)):1===s&&e.deleteNode(t.id),e.resumeSimulation(),e.releaseNodePosition(t)}));const c=l.node();c.parentNode.insertBefore(c,c.parentNode.firstChild),O.Ltv("body").on("click",(()=>{O.Ubm(".radial-menu").remove(),e.resumeSimulation(),e.releaseNodePosition(t)}))}function Y(e,t,i){const n=e.svg,s=e.zoom,a=e.width,o=e.height,r=O.GSI.translate(a/4,o/2).scale(i).translate(-t.x,-t.y);n.transition().duration(750).call(s.transform,r).on("end",(()=>{}))}function J(e,t,i){e.active||i.alphaTarget(.3).restart(),t.fx=t.x,t.fy=t.y}function B(e,t){clearTimeout(this.dragTimeout),t.fx=e.x,t.fy=e.y}function Z(e,t,i){e.active||i.alphaTarget(0),t.fx=null,t.fy=null}i(7642),i(8004),i(3853),i(5876),i(2475),i(5024),i(1698),i(7550);const q=["stigma","no stigma"];function ee(e,t,i,n){if(n.length>0)return;const s=i.selectAll("path"),a=i.selectAll("circle"),o=i.selectAll(".node-label"),r=new Set;s.style("opacity",(t=>{const i=t.source===e||t.target===e;return i&&(r.add(t.source),r.add(t.target)),i?1:.1})).style("color",(e=>e.color)),a.style("opacity",(t=>t===e||r.has(t)?1:.1)),o.style("opacity",(t=>t===e||r.has(t)?1:.1))}function te(e,t,i,n,s){if(O.Ubm(".tooltip").remove(),i.length>0)return;const a=t.selectAll("path"),o=t.selectAll("circle"),r=t.selectAll(".node-label");a.style("opacity",1),o.style("opacity",1),r.style("opacity",1),s(0),n(!1)}function ie(e,t,i){const n=t.selectAll("path"),s=t.selectAll("circle"),a=t.selectAll(".node-label");n.style("opacity",(t=>{if(!t.source||!t.target)return.1;const n=t===e,s=i.length>0&&i.includes(t.source.type)&&i.includes(t.target.type);return n||s?1:.1})).style("color",(e=>e.color)),s.style("opacity",(t=>{const n=t===e.source||t===e.target,s=i.includes(t.type)||q.includes(t.type);return n||s?1:.1})),a.style("opacity",(t=>{const n=t===e.source||t===e.target,s=i.includes(t.type)||q.includes(t.type);return n||s?1:.1}))}function ne(e,t,i,n,s){if(i.length>0)return;const a=t.selectAll("path"),o=t.selectAll("circle"),r=t.selectAll(".node-label");a.style("opacity",1),o.style("opacity",1),r.style("opacity",1),s(0),n(!1)}function se(e){const t=O.yWT(e),i=.299*t.r+.587*t.g+.114*t.b;return i>170?"black":"white"}function ae(e){const t=.2,i=.4,n=5;O.Ubm(".node-label").attr("display",(s=>e>=n||e>=i&&s.size>=30||e>=t&&s.size>=60||e<t&&s.size>=100?"block":"none"))}function oe(e,t){const i=t.indexOf(e);-1!==i?t.splice(i,1):t.push(e)}function re(e,t,i,n,s){const a=e.selectAll("circle"),o=e.selectAll("path"),r=e.selectAll(".node-label"),l=["stigma","no stigma"];if(0===i.length)return a.style("opacity",1),o.style("stroke-opacity",1),r.style("opacity",1),s(0),void n(!1);a.style("opacity",(e=>i.includes(e.construct)||l.includes(e.construct)?1:.1)),o.style("opacity",(e=>{if(!e||!e.source||!e.target)return.1;const t=i.includes(e.source.construct)||l.includes(e.source.construct),n=i.includes(e.target.construct)||l.includes(e.target.construct);return t&&n?1:.1})),r.style("opacity",(e=>i.includes(e.construct)||l.includes(e.construct)?1:.1));const c=t.filter((e=>i.includes(e.construct)||l.includes(e.construct))).length;s(c),n(!0)}function le(e,t,i){const n=e.selectAll("circle"),s=e.selectAll("path"),a=e.selectAll(".node-label");n.style("opacity",1),s.style("stroke-opacity",1),a.style("opacity",1),t(0),i(!1)}function ce(e,t){const i=new Set(t.map((e=>`${e.cause}||${e.effect}`))),n=e.selectAll("path"),s=e.selectAll("circle"),a=e.selectAll(".node-label");if(0===i.size)return n.style("opacity",1),s.style("opacity",1),void a.style("opacity",1);n.style("opacity",(e=>i.has(`${e.source.name||e.source.id}||${e.target.name||e.target.id}`)?1:.1)),s.style("opacity",(e=>t.some((t=>t.cause===e.name||t.effect===e.name))?1:.1)),a.style("opacity",(e=>t.some((t=>t.cause===e.name||t.effect===e.name))?1:.1))}function de(e,t){const i=e.selectAll("path"),n=e.selectAll("circle"),s=e.selectAll(".node-label");i.style("opacity",.1),n.style("opacity",(e=>e===t?1:.1)),s.style("opacity",(e=>e===t?1:.1))}var he=i(4526);function ue(e){if(e.selectedInstances=e.selectedInstances.filter((e=>!e.isNew)),e.currentIndex>=e.selectedInstances.length&&(e.currentIndex=e.selectedInstances.length>0?e.selectedInstances.length-1:0),0===e.selectedInstances.length&&(e.isInstanceContentVisible=!1),e.isNodeEditMode){const t=e.nodes.find((t=>t.name===e.selectedNodeName));e.nodes=e.nodes.filter((e=>!(e.isDraft&&e.name===t.name))),e.links=e.links.filter((e=>{const i=e.source.name===t.name||e.target.name===t.name;return!(e.preview&&i)}))}e.isAddingNewNode=!1,e.isEditMode=!1,e.isNodeEditMode=!1,e.$emit("close-instance"),e.mainGroup.selectAll("*").remove(),e.renderGraph()}function pe(e){if(e.undoStack.length>0){const t=e.undoStack.pop();e.instances=t.instances,e.selectedInstances=t.selectedInstances,e.selectedNodeName=t.selectedNodeName,e.nodes=t.nodes,e.links=ye(e.nodes,t.links),e.isInstanceContentVisible=t.isInstanceContentVisible,Array.isArray(e.selectedInstances)&&e.selectedInstances.forEach((e=>{e&&(e.editableName=!1)})),e.mainGroup.selectAll("*").remove(),e.renderGraph()}else console.log("No actions to undo")}async function ge(e,t){if(0===e.userOperations.length)return alert("There are no operations to be saved");e.tempIdMapping=e.tempIdMapping||{};const i=e.tempIdMapping;try{for(const n of e.userOperations){const s=JSON.parse(n.operationData);console.log("op:",n);const a=e.userId||localStorage.getItem("userId");if("NODE_CREATE"===n.operationType){const n=await t.post(`${W.baseURL}/api/${a}/sentences/create/`,{text:s.sentenceText}),o=n.data.id,r=await t.post(`${W.baseURL}/api/${a}/entities/create/`,{name:s.nodeName,sentence_id:o,construct_id:s.construct,canonical_entity_id:null}),l=r.data.id;await t.put(`${W.baseURL}/api/entity/${l}/update/`,{canonical_entity_id:l}),i[s.tempId]=l;const c=e.nodes.find((e=>e.tempId===s.tempId));c&&(c.id=l)}else if("LINK_CREATE"===n.operationType){const e=i[s.sourceTempId]||s.sourceTempId,n=i[s.targetTempId],o=await t.get(`${W.baseURL}/api/entity/${n}/`).then((e=>e.data.sentence_id));console.log(o),await t.post(`${W.baseURL}/api/${a}/triples/create/`,{sentence_id:o,entity_cause_id:e,entity_effect_id:n})}else if("INSTANCE_UPDATE"===n.operationType){const e=i[s.instanceId]||s.instanceId;await t.put(`${W.baseURL}/api/entity/${e}/update/`,{name:s.updatedFields.name,construct_id:s.updatedFields.construct_id,sentence_id:s.updatedFields.sentence_id})}else if("INSTANCE_DELETE"===n.operationType){const e=i[s.instanceId]||s.instanceId;await t.delete(`${W.baseURL}/api/entity/${e}/delete/`)}else if("NODE_DELETE"===n.operationType){const e=i[s.nodeId]||s.nodeId;await t.delete(`${W.baseURL}/api/entity/${e}/delete/`)}}e.userOperations=[],e.isDirty=!1,alert("Save successful!"),e.mainGroup.selectAll("*").remove(),await e.fetchGraphData()}catch(n){console.error("saveAllOperations error",n),alert("Save failed. Please check the network or try again later")}}function me(){const e=document.querySelector(".instance-content");e&&(e.style.transition="none",e.style.transform="translateY(-150%)",e.offsetHeight,e.style.transition="transform 0.5s ease",e.style.transform="translateY(0)")}function ke(e){const t=e.selectedInstances[0]||{};if(e.validationErrors={},t.name&&t.name.trim()){const i=t.name.trim().toLowerCase(),n=e.nodes.find((e=>{const n=e.isDraft&&e.tempId===t.id;return!n&&(e.name||"").trim().toLowerCase()===i}));n&&(e.validationErrors.name="A node with this name already exists.")}else e.validationErrors.name="Node name cannot be empty.";return t.construct_id||(e.validationErrors.construct="Please select a construct."),t.sentence&&t.sentence.trim()||(e.validationErrors.sentence="Sentence text cannot be empty."),0===Object.keys(e.validationErrors).length}function fe(e){const t=e.selectedInstances[e.currentIndex]||{};return e.validationErrors={},t.name&&t.name.trim()||(e.validationErrors.name="Instance name cannot be empty."),t.construct_id||(e.validationErrors.construct="Please select a construct."),t.sentence&&t.sentence.trim()||(e.validationErrors.sentence="Sentence text cannot be empty."),0===Object.keys(e.validationErrors).length}function ye(e,t){const i=new Map(e.map((e=>[e.name,e])));return t.map((e=>({...e,source:"string"===typeof e.source?i.get(e.source):i.get(e.source.name),target:"string"===typeof e.target?i.get(e.target):i.get(e.target.name)})))}function ve(e){if(e.isAddingNewNode)return;e.isAddingNewNode=!0;const t=(0,he.A)(),i={tempId:t,name:"New Node",color:"#D3B5E5",size:50,x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,editableName:!0,isDraft:!0};e.nodes.push(i);const n=e.nodes.find((t=>t.name===e.clickedNodeName));e.links.push({tempId:(0,he.A)(),source:n,target:i,preview:!0,value:10,distance:200,color:n.color||"#999999"}),e.simulation.nodes(e.nodes),e.simulation.force("link").links(e.links),e.simulation.alpha(1),e.simulation.restart(),e.mainGroup.selectAll("*").remove(),e.renderGraph();const s={id:t,name:i.name,sentence_id:null,canonical_entity_id:t,construct_id:null,embeddings:{},isNew:!0,editableName:!0};e.selectedNodeName=i.name,e.selectedInstances=[s],e.currentIndex=0,e.instances[s.id]=[s],e.draft={nodeName:"",sentenceText:""};const a={nodeName:e.selectedNodeName,instances:e.selectedInstances,currentIndex:0,isEditMode:!0,isInstanceContentVisible:!0};e.$emit("show-instance",a),e.$nextTick((()=>{e.showInstanceContent()})),e.isInstanceContentVisible=!0,e.isEditMode=!0,e.isNodeEditMode=!0}async function we(e){const t=e.selectedInstances[0],{name:i,sentence:n,construct_id:s}=t,a=t.construct;if(!ke(e))return console.error("Validation errors:",e.validationErrors),e.nodes=e.nodes.filter((e=>!e.isDraft)),e.links=e.links.filter((e=>!e.preview)),e.isAddingNewNode=!1,e.$emit("close-instance"),e.mainGroup.selectAll("*").remove(),void e.renderGraph();try{const o=await H.A.post(`${W.baseURL}/api/${e.userId}/sentences/create/`,{text:n}),r=o.data.id,l=o.data.line_number;t.sentence_id=r,t.line_number=l;const c=await H.A.post(`${W.baseURL}/api/${e.userId}/entities/create/`,{name:i,sentence_id:r,construct_id:s,canonical_entity_id:null}),d=c.data.id;t.id=d,t.canonical_entity_id=d,t.isNew=!1,await H.A.put(`${W.baseURL}/api/entity/${d}/update/`,{canonical_entity_id:d});const h=e.links.find((e=>e.preview));if(h){const t=h.source.id;await H.A.post(`${W.baseURL}/api/${e.userId}/triples/create/`,{sentence_id:r,entity_cause_id:t,entity_effect_id:d}),h.preview=!1}const u=e.nodes.find((e=>e.isDraft));u.id=d,e.instances[d]=e.instances[u.tempId],delete e.instances[u.tempId],u.name=i,u.isDraft=!1,u.editableName=!1,u.color=e.colorScale(a),e.isAddingNewNode=!1,e.isNodeEditMode=e.isEditMode=!1,e.$emit("graph-updated"),e.mainGroup.selectAll("*").remove(),e.renderGraph(),Y(e,u,5)}catch(o){console.error("saveCurrentNode error",o),alert("Node creation failed. Please try again")}}async function Ce(e,t){const i=(e.instances[t]||[]).filter((e=>e.id!==t));for(const a of i)if(!a.isNew)try{await H.A.delete(`${W.baseURL}/api/entity/${a.id}/delete/`)}catch(s){console.error(`The deletion of instance ${a.id} failed :`,s)}try{await H.A.delete(`${W.baseURL}/api/entity/${t}/delete/`)}catch(s){return void console.error(`Failed to delete node ${t} :`,s)}const n=e.nodes.findIndex((e=>e.id===t));-1!==n&&e.nodes.splice(n,1),delete e.instances[t],e.links=e.links.filter((e=>e.source.id!==t&&e.target.id!==t)),e.$emit("close-instance"),e.$emit("graph-updated"),e.mainGroup.selectAll("*").remove(),e.renderGraph()}function xe(e){e.isEditMode=!0,e.selectedInstances.forEach((e=>e.editableName=!0))}function Le(e){const t=(0,he.A)(),i=e.selectedInstances[0]?.canonical_entity_id||e.selectedInstances[0]?.id,n={id:t,name:e.selectedNodeName,canonical_entity_id:i,construct_id:null,sentence_id:null,sentence:"",isCreate:!0,editableName:!1};e.selectedInstances.push(n),e.currentIndex=e.selectedInstances.length-1,e.isEditMode=!0,e.$emit("show-instance",{nodeName:e.selectedNodeName,instances:e.selectedInstances,currentIndex:e.currentIndex,isEditMode:!0,isInstanceContentVisible:!0})}async function Ie(e){const t=e.selectedInstances[e.currentIndex];if(console.log(t),fe(e))try{const i=await H.A.post(`${W.baseURL}/api/${e.userId}/sentences/create/`,{text:t.sentence}),n=i.data.id,s=i.data.line_number;if(t.sentence_id=n,t.line_number=s,t.isCreate){const i=await H.A.post(`${W.baseURL}/api/${e.userId}/entities/create/`,{name:t.name,sentence_id:n,construct_id:t.construct_id,canonical_entity_id:t.canonical_entity_id});t.id=i.data.id,t.isNew=!1,t.canonical_entity_id=e.selectedInstances[0].id}else await H.A.put(`${W.baseURL}/api/entity/${t.id}/update/`,{name:t.name,sentence_id:n,construct_id:t.construct_id}),t.sentence_id=n;e.isEditMode=!1,t.editableName=!1,e.mainGroup.selectAll("*").remove(),e.renderGraph()}catch(i){console.error("Error in saving the instance: ",i),alert("Failed to save the instance. Please try again later.")}else console.error("Verification failed: ",e.validationErrors)}async function Ee(e,t){if(t<0||t>=e.selectedInstances.length)return;const i=e.selectedInstances[t],n=i.id||i.tempId,s=i.canonical_entity_id;try{await H.A.delete(`${W.baseURL}/api/entity/${n}/delete/`)}catch(a){return console.error(`Failed to delete instance ${n}:`,a),void alert("The instance deletion failed. Please try again later")}e.selectedInstances.splice(t,1),e.instances[e.selectedNodeName]=[...e.selectedInstances],e.selectedInstances.length>0?e.currentIndex>=e.selectedInstances.length&&(e.currentIndex=e.selectedInstances.length-1):(e.nodes=e.nodes.filter((e=>(e.id||e.tempId)!==s)),e.links=e.links.filter((e=>(e.source.id||e.source.tempId)!==s&&(e.target.id||e.target.tempId)!==s)),delete e.instances[s],e.$emit("close-instance")),e.$emit("graph-updated"),e.mainGroup.selectAll("*").remove(),e.renderGraph()}function be(e){e.currentSlideIndex>0&&(e.currentSlideIndex--,$e(e))}function Ne(e){e.currentSlideIndex<e.interviewOptions.length-1&&(e.currentSlideIndex++,$e(e))}function $e(e){e.selectedInstances[e.currentIndex]&&(e.selectedInstances[e.currentIndex].question=e.displayedInterview)}async function Se(e){if(e.searchQuery)try{const t={nodes:e.nodes.map((e=>e.name)),query:e.searchQuery},i=await H.A.post(`${W.baseURL}/api/${e.userId}/search/search-with-nodes/`,t);if(e.searchResults=i.data,e.searchResults.length>0){const t=e.searchResults[0];if(0===t.distance){const i=e.nodes.find((e=>e.name===t.name));i&&Y(e,i,2)}}}catch(t){console.error("Search error:",t)}}var _e=i.p+"img/refresh.6c5423d3.svg",Ae={name:"App",props:{userId:{type:String,required:!0}},emits:["node-selected","show-instance","close-instance","graph-updated","construct-clicked","edge-clicked","edge-clicked-name","refresh"],data(){return{nodes:[],links:[],instances:[],svg:null,zoom:null,zoomPercent:40,width:0,height:0,initialX:0,initialY:0,initialPositions:{},selectedNodeName:"",selectedInstances:[],currentIndex:0,simulation:null,mainGroup:null,isInstanceContentVisible:!1,highlightedLegendTypes:[],highlightedCount:0,totalNodeCount:0,showHighlightStats:!1,isEditMode:!1,isNodeEditMode:!1,undoStack:[],constructs:[],typeOptions:[],colorScale:null,currentSlideIndex:0,userOperations:[],isCreateNewNode:!1,validationErrors:{},isDirty:!0,graphLoading:!0,showArrows:!1,isAddingNewNode:!1,searchQuery:"",searchResults:[],colorRange:[],clickedNode:null,clickedLink:null,highlightLocked:!1,filterLocked:!1,RefreshIcon:_e,sizeThreshold:0,firstFilterInit:!0}},computed:{minRadius(){const e=this.nodes.map((e=>e.size));return Math.min(...e)},maxRadius(){const e=this.nodes.map((e=>e.size));return Math.max(...e)},filterPercent(){if(!this.totalNodeCount)return"—";const e=this.nodes.filter((e=>e.size>=this.sizeThreshold)).length;return(e/this.totalNodeCount*100).toFixed(1)+"%"}},watch:{nodes(e){this.firstFilterInit&&e.length&&(this.sizeThreshold=this.minRadius,this.firstFilterInit=!1)}},async mounted(){this.userOperations=[];const e=await H.A.get(`${W.baseURL}/api/${this.userId}/constructs/`);this.constructs=e.data;const t=this.constructs.map((e=>e.name));this.colorRange=this.constructs.map((e=>e.color)),this.sizeThreshold=this.minRadius,this.colorScale=O.UMr().domain(t).range(this.colorRange),this.typeOptions=t,this.initializeVisualization(),await this.fetchGraphData(),this.mainGroup.selectAll("*").remove(),this.renderGraph(),window.addEventListener("beforeunload",(e=>{this.isDirty&&(e.preventDefault(),e.returnValue="You have unsaved changes. Are you sure you want to leave?")}))},methods:{pauseSimulation(){this.simulation&&(this.simulation.alphaTarget(0),this.simulation.stop())},resumeSimulation(){this.simulation&&this.simulation.restart()},fixNodePosition(e){e.fx=e.x,e.fy=e.y},releaseNodePosition(e){e.fx=null,e.fy=null},initializeVisualization(){const e=window.innerWidth,t=window.innerHeight;this.width=e,this.height=t;const i=.3;this.initialX=e/12,this.initialY=t/4;const n=O.Ltv("#chart").append("svg").attr("width",e).attr("height",t);this.svg=n,this.mainGroup=n.append("g");const s=this.svg.append("defs");this.colorRange.forEach((e=>{const t=s.append("marker").attr("id",`arrow-${e.slice(1)}`).attr("markerUnits","userSpaceOnUse").attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",20).attr("markerHeight",20).attr("orient","auto");t.append("path").attr("d","M0,-5L10,0L0,5").attr("fill","currentColor"),t.style("color",e)})),this.zoom=O.s_O().scaleExtent([.1,10]).on("zoom",(e=>{this.mainGroup.attr("transform",e.transform),this.zoomPercent=Math.round(100*e.transform.k),this.handleZoom(e.transform.k)})),n.call(this.zoom),n.call(this.zoom.transform,O.GSI.translate(this.initialX,this.initialY).scale(i));const a=O.Ltv(this.$refs.MainLegendContainer).attr("width",100).attr("height",t),o=a.append("g").attr("transform","translate(10, 20)"),r=this.typeOptions.map((e=>({name:e,color:this.colorScale(e)}))),l=o.selectAll(".legend-item").data(r).enter().append("g").attr("class","legend-item").attr("transform",((e,t)=>`translate(0, ${20*t})`)).on("click",((e,t)=>{this.toggleHighlight(t.name)}));l.append("rect").attr("x",0).attr("y",0).attr("width",15).attr("height",15).attr("fill",(e=>e.color)),l.append("text").attr("x",20).attr("y",12).attr("font-size","12px").text((e=>e.name));const c=a.append("g").attr("transform",`translate(10, ${20*this.typeOptions.length+50})`),d=c.append("g").attr("class","legend-size").attr("transform","translate(0, 0)");d.append("circle").attr("cx",7).attr("cy",7).attr("r",5).attr("fill","#000"),d.append("text").attr("x",20).attr("y",11).attr("font-size","12px").text("fewer connections"),d.append("circle").attr("cx",7).attr("cy",27).attr("r",10).attr("fill","#000"),d.append("text").attr("x",20).attr("y",31).attr("font-size","12px").text("more connections");const h=c.append("g").attr("class","legend-link").attr("transform","translate(0, 60)");h.append("line").attr("x1",0).attr("y1",0).attr("x2",20).attr("y2",0).attr("stroke","#000").attr("stroke-width",1),h.append("text").attr("x",30).attr("y",4).attr("font-size","12px").text("appears less"),h.append("line").attr("x1",0).attr("y1",20).attr("x2",20).attr("y2",20).attr("stroke","#000").attr("stroke-width",4),h.append("text").attr("x",30).attr("y",24).attr("font-size","12px").text("appears more")},handleZoom(e){ae(e)},async fetchGraphData(){try{const[e,t]=await Promise.all([H.A.get(`${W.baseURL}/api/${this.userId}/entities/`),H.A.get(`${W.baseURL}/api/${this.userId}/triples/`)]),i=e.data,n=t.data,s=new Map(i.map((e=>[e.id,e]))),a=new Map,o={};i.forEach((e=>{e.canonical_entity_id===e.id&&a.set(e.id,{id:e.id,name:e.name,color:this.colorScale(e.construct||"unknown"),construct:e.construct,canonical_entity_id:e.canonical_entity_id,occurrence:0,size:0})})),a.forEach(((e,t)=>{o[t]=[]})),i.forEach((e=>{const t=e.canonical_entity_id;o[t]||(a.set(t,{id:t,name:s.get(t)?.name||t,color:this.colorScale(s.get(t)?.construct||"unknown"),construct:s.get(t)?.construct,canonical_entity_id:e.canonical_entity_id,occurrence:0,size:0}),o[t]=[]),o[t].push(e)}));const r=new Map;n.forEach((e=>{const t=s.get(e.entity_cause_id),i=s.get(e.entity_effect_id);if(!t||!i)return;const n=t.canonical_entity_id,o=i.canonical_entity_id,l=a.get(n),c=a.get(o);if(!l||!c)return;l.occurrence+=1,l.size+=1,c.occurrence+=1,c.size+=1;const d=`${n}||${o}`;r.has(d)?r.get(d).value+=1:r.set(d,{source:l,target:c,value:1,distance:1,color:l.color})}));const l=Array.from(a.values()),c=Array.from(r.values());l.forEach((e=>{0===e.occurrence&&0===e.size&&(e.occurrence=1,e.size=1)})),this.processData(o,l,c)}catch(e){console.error("Error fetching graph data:",e)}},processData(e,t,i){const n=t.map((e=>e.size||1)),s=i.map((e=>e.distance||1)),a=i.map((e=>e.value||1)),o=O.Bv9().domain([O.jkA(n),O.T9B(n)]).range([50,100]).clamp(!0),r=O.Bv9().domain([O.jkA(s),O.T9B(s)]).range([300,600]).clamp(!0),l=O.Bv9().domain([O.jkA(a),O.T9B(a)]).range([10,50]).clamp(!0);this.nodes=t.map((e=>({...e,size:o(e.size),color:e.color||"#cccccc",x:e.x||Math.random()*window.innerWidth,y:e.y||Math.random()*window.innerHeight})));const c=new Map(this.nodes.map((e=>[e.id,e])));this.links=i.map((e=>{const t=c.get(e.source.id||e.source),i=c.get(e.target.id||e.target);return t&&i?{...e,source:t,target:i,color:e.color||"#999999",distance:r(e.distance),value:e.value,ScaledValue:l(e.value)}:(console.warn("Missing source or target for link:",e),null)})).filter((e=>null!==e)),this.instances=e,this.totalNodeCount=this.nodes.length,this.renderGraph()},renderGraph(){const e=window.innerWidth,t=window.innerHeight;this.simulation=O.tXi(this.nodes).force("link",O.kJC(this.links).id((e=>e.name)).distance((e=>e.distance))).force("charge",O.xJS().strength(0)).force("center",O.jTM(e/2,t/2)).force("collision",O.eRw().radius((e=>e.size+20))).alpha(1).restart().alphaDecay(.05).on("tick",(()=>this.ticked())).on("end",(()=>{this.graphLoading=!1})),this.updateGraph()},updateGraph(){const e=this.mainGroup.append("g").selectAll("path").data(this.links).enter().append("path").attr("fill","none").attr("stroke-width",(e=>Math.sqrt(e.ScaledValue))).attr("stroke",(e=>e.color)).attr("marker-end",(e=>`url(#arrow-${e.color.slice(1)})`)).on("mouseover",((e,t)=>{this.highlightLocked||this.highlightLink(t)})).on("mouseout",((e,t)=>{this.highlightLocked||this.resetHighlightLink(t)})).on("click",((e,t)=>this.handleLinkClick(t)));e.append("title").text((e=>`Weight: ${e.value}, ${e.target.name} because ${e.source.name}`));const t=this.mainGroup.append("g").selectAll("circle").data(this.nodes).enter().append("circle").attr("r",(e=>e.size)).attr("fill",(e=>e.color)).attr("data-name",(e=>e.name)).attr("cx",(e=>this.initialPositions[e.name]?.x||Math.random()*window.innerWidth)).attr("cy",(e=>this.initialPositions[e.name]?.y||Math.random()*window.innerHeight)).attr("stroke",(e=>O.yWT(e.color).darker(1))).call(O.$Er().filter(((e,t)=>!t.isThirdElement)).on("start",((e,t)=>J(e,t,this.simulation))).on("drag",((e,t)=>{clearTimeout(this.dragTimeout),B.call(this,e,t)})).on("end",((e,t)=>Z(e,t,this.simulation)))).on("click",((e,t)=>{this.onNodeClick(e,t)})).on("mouseover",((e,t)=>{this.highlightLocked||this.highlightNode(t,e,this.mainGroup,[])})).on("mouseout",((e,t)=>{this.highlightLocked||this.resetHighlightNode(t,this.mainGroup,[],(()=>{}),(()=>{}))}));t.append("title").text((e=>`Name: ${e.name}\nConstruct: ${e.construct}`));const i=this.mainGroup.append("g").selectAll("foreignObject").data(this.nodes).enter().append("foreignObject").attr("class","node-label").attr("width",(e=>3*e.size)).attr("height",(e=>3*e.size)).attr("display",(e=>e.isThirdElement?"none":"block")).attr("font-size",(e=>10===e.size?"3px":`${Math.max(e.size/3,10)}px`)).style("pointer-events","none").append("xhtml:div").style("word-wrap","break-word").style("white-space","normal").style("text-align","center").style("display","flex").style("align-items","center").style("justify-content","center").style("height","100%").append("div").style("background-color",(e=>{const t=O.yWT(e.color);return O.Qhc(t.r+40,t.g+40,t.b+40,.8)})).style("color","#000").style("border",(e=>`1px solid ${O.yWT(e.color).darker(1)}`)).style("padding","2px 4px").text((e=>e.name));this.simulation.nodes(this.nodes).on("tick",(()=>this.ticked(e,t,i))),this.simulation.force("link").links(this.links)},updateZoom(){const e=this.zoomPercent/100;if(this.zoom&&O.Ltv("#chart svg")){const t=O.GSI.translate(this.initialX,this.initialY).scale(e);O.Ltv("#chart svg").transition().duration(200).call(this.zoom.transform,t)}else console.error("Zoom or SVG transform is not initialized")},getTextColor(e){return se(e)},highlightNode(e){this.highlightLocked||ee(e,event,this.mainGroup,this.highlightedLegendTypes)},resetHighlightNode(e){te(e,this.mainGroup,this.highlightedLegendTypes,(e=>this.showHighlightStats=e),(e=>this.highlightedCount=e))},highlightLink(e){this.highlightLocked||ie(e,this.mainGroup,this.highlightedLegendTypes)},resetHighlightLink(e){ne(e,this.mainGroup,this.highlightedLegendTypes,(e=>this.showHighlightStats=e),(e=>this.highlightedCount=e))},handleLinkClick(e){if(this.filterLocked)return;if(this.highlightLocked&&(this.clickedLink&&this.clickedLink!==e||this.clickedNode))return;if(this.clickedLink===e)return this.resetHighlightLink(this.mainGroup,[]),this.clickedLink=null,this.highlightLocked=!1,void this.$emit("edge-clicked",null);this.clickedNode&&(this.resetHighlightNode(this.clickedNode,this.mainGroup,[],(()=>{}),(()=>{})),this.clickedNode=null),this.clickedLink&&this.resetHighlightLink(this.mainGroup,[]),this.highlightLink(e,this.mainGroup,[]),this.clickedLink=e,console.log(e),this.highlightLocked=!0;const t={source:e.source.construct||e.source.id,target:e.target.construct||e.target.id},i={source:e.source.name||e.source.id,target:e.target.name||e.target.id};this.$emit("edge-clicked",t),this.$emit("edge-clicked-name",i)},ticked(){this.mainGroup.selectAll("path").attr("d",(e=>!e.source||!e.target||isNaN(e.source.x)||isNaN(e.source.y)||isNaN(e.target.x)||isNaN(e.target.y)?"":(()=>{const t=e.target.x-e.source.x,i=e.target.y-e.source.y,n=Math.hypot(t,i)||1,s=e.source.size,a=e.target.size,o=e.source.x+t/n*s,r=e.source.y+i/n*s,l=e.target.x-t/n*a,c=e.target.y-i/n*a,d=(o+l)/2,h=(r+c)/2-100;return`M ${o} ${r} Q ${d} ${h} ${l} ${c}`})())),this.mainGroup.selectAll("circle").attr("cx",(e=>isNaN(e.x)?0:e.x)).attr("cy",(e=>isNaN(e.y)?0:e.y)),this.mainGroup.selectAll(".node-label").data(this.nodes).attr("x",(e=>isNaN(e.x)?0:e.x-1.5*e.size)).attr("y",(e=>isNaN(e.y)?0:e.y-1.5*e.size));const e=this.nodes.map((e=>({name:e.name,x:e.x,y:e.y})));localStorage.setItem("nodePositions",JSON.stringify(e))},prevInstance(){this.currentIndex>0&&this.currentIndex--},nextInstance(){this.currentIndex<this.selectedInstances.length-1&&this.currentIndex++},jumpToInterview(e){this.currentSlideIndex=e},async goToNodeView(){try{if(this.isDirty){const e=window.confirm("You have unsaved changes. Do you really want to leave?");if(!e)return}if(!this.selectedNodeName&&(!this.selectedInstances||0===this.selectedInstances.length))return console.error("No node or instance is selected."),void alert("Please select a node or instance before navigating.");const e=this.selectedNodeName||this.selectedInstances[this.currentIndex]&&this.selectedInstances[this.currentIndex].name;if(!e)return console.error("Current node name is not valid."),void alert("The selected node name is invalid. Please try again.");this.$router.push({name:"NodeView",query:{userId:this.userId,id:e}})}catch(e){console.error("An error occurred while navigating to the node view:",e),alert("Failed to navigate to the node view. Please try again later.")}},onNodeClick(e,t){this.filterLocked||(this.graphLoading?alert("The graph is still loading. Please wait a moment."):j(this,e,t))},cancelEdit(){this.isInstanceContentVisible=!1,ue(this)},EditInstance(){xe(this)},addNewInstance(){Le(this)},async saveCurrentInstance(){await Ie(this)},deleteInstance(e){Ee(this,e)},addNewNode(){ve(this)},async saveCurrentNode(){await we(this)},deleteNode(e){Ce(this,e)},undoOperation(){pe(this)},showInstanceContent(){me()},async saveAllOperations(){await ge(this,H.A,W)},hideInstanceContent(){this.isInstanceContentVisible=!1,ue(this)},toggleHighlight(e){oe(e,this.highlightedLegendTypes),this.applyHighlight()},applyHighlight(){re(this.mainGroup,this.nodes,this.highlightedLegendTypes,(e=>this.showHighlightStats=e),(e=>this.highlightedCount=e)),this.filterLocked=this.highlightedLegendTypes.length>0,this.highlightLocked=this.filterLocked},resetHighlight(){le(this.mainGroup,(e=>this.highlightedCount=e),(e=>this.showHighlightStats=e))},highlightTriples(e){ce(this.mainGroup,e)},highlightOnlyNode(e){de(this.mainGroup,e)},clearValidationErrors(){this.validationErrors={}},prevInterview(){be()},nextInterview(){Ne()},updateQuestion(){$e()},async handleSearch(){await Se(this)},zoomToSearchResult(e){const t=this.nodes.find((t=>t.name===e.name));t&&Y(this,t,2)},clearSearchResults(){this.searchResults=[],this.searchQuery=""},handleRefresh(){this.clickedNode&&(te(this.clickedNode,this.mainGroup,[],(()=>{}),(()=>{})),this.clickedNode=null),this.clickedLink&&(ne(this.clickedLink,this.mainGroup,[],(()=>{}),(()=>{})),this.clickedLink=null),this.highlightLocked=!1,this.filterLocked=!1,this.highlightedLegendTypes=[],le(this.mainGroup,(()=>this.highlightedCount=0),(()=>this.showHighlightStats=!1)),this.$emit("edge-clicked",null),this.$emit("refresh")},onSizeFilterChange(){this.filterByRadius(this.sizeThreshold)},filterByRadius(e){this.mainGroup.selectAll("circle").style("display",(t=>t.size>=e?null:"none")),this.mainGroup.selectAll(".node-label").style("display",(t=>t.size>=e?null:"none")),this.mainGroup.selectAll("path").style("display",(t=>t.source.size>=e&&t.target.size>=e?null:"none"))},increaseZoom(){this.zoomPercent=Math.min(this.zoomPercent+10,1e3),this.updateZoom()},decreaseZoom(){this.zoomPercent=Math.max(this.zoomPercent-10,10),this.updateZoom()}}};const ze=(0,l.A)(Ae,[["render",D],["__scopeId","data-v-6ad9aa1d"]]);var Te=ze;const Me={class:"d3-container"},Re={ref:"svg"},Xe={class:"window-header"},Ue={class:"edge-window-title"},Ge={class:"edge-table"};function Fe(e,t,i,n,a,o){return(0,s.uX)(),(0,s.CE)("div",Me,[t[4]||(t[4]=(0,s.Lk)("div",{class:"header-bar"},[(0,s.Lk)("h3",{class:"page-title"},"Concept View")],-1)),((0,s.uX)(),(0,s.CE)("svg",Re,null,512)),a.showTooltip?((0,s.uX)(),(0,s.CE)("div",{key:0,class:"entity-tooltip",style:(0,u.Tr)(a.tooltipStyle)},[(0,s.Lk)("button",{class:"close-btn",onClick:t[0]||(t[0]=t=>{a.showTooltip=!1,a.edgeTableData=[],e.$emit("triples-highlight",[])})},"×"),(0,s.Lk)("ul",null,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(a.tooltipEntities,(e=>((0,s.uX)(),(0,s.CE)("li",{key:e.id},(0,u.v_)(e.name),1)))),128))])],4)):(0,s.Q3)("",!0),a.edgeTableData.length?((0,s.uX)(),(0,s.CE)("div",{key:1,class:"edge-table-window",style:(0,u.Tr)(o.windowStyle),onMousedown:t[2]||(t[2]=(...e)=>o.startDrag&&o.startDrag(...e))},[(0,s.Lk)("div",Xe,[(0,s.Lk)("span",Ue,(0,u.v_)(a.edgeTableHeader),1),(0,s.Lk)("button",{class:"close-btn",onClick:t[1]||(t[1]=e=>a.edgeTableData=[])},"×")]),(0,s.Lk)("table",Ge,[t[3]||(t[3]=(0,s.Lk)("thead",null,[(0,s.Lk)("tr",null,[(0,s.Lk)("th",null,"cause"),(0,s.Lk)("th",null,"effect")])],-1)),(0,s.Lk)("tbody",null,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(a.edgeTableData,((e,t)=>((0,s.uX)(),(0,s.CE)("tr",{key:t},[(0,s.Lk)("td",null,(0,u.v_)(e.cause),1),(0,s.Lk)("td",null,(0,u.v_)(e.effect),1)])))),128))])])],36)):(0,s.Q3)("",!0)])}i(8872);var Pe={name:"TheoryView",emits:["graph-updated","construct-clicked","triples-highlight"],data(){const e=window.innerWidth/2,t=window.innerHeight/2;return{userId:localStorage.getItem("userId")||"",apiUrl:"",svg:null,width:0,height:0,zoom:null,zoomPercent:40,initialX:0,initialY:0,container:null,nodes:[],links:[],constructs:[],colorScale:null,typeOptions:[],entities:[],triples:[],showTooltip:!1,tooltipEntities:[],tooltipStyle:{},edgeTableData:[],edgeTableHeader:"",winX:e,winY:t,dragging:!1,dragStartX:0,dragStartY:0,winStartX:0,winStartY:0,nodeSel:null,linkSel:null,lastClicked:null,lastClickedEdgeKey:null,totalIndicators:0,totalNodeSize:0,totalTriples:0,totalEdgeValue:0,parallelGroups:null}},props:{graph:{type:Object,required:!1},selectedConstruct:{type:String,default:null},clickedEdge:{type:Object,default:null}},watch:{userId(e){e?localStorage.setItem("userId",e):localStorage.removeItem("userId")},selectedConstruct(e){e?this.highlightConstructSingle(e):this.resetHighlight()},clickedEdge(e){e?this.highlightConceptEdge(e.source,e.target):this.resetConceptHighlight()}},computed:{windowStyle(){return{position:"fixed",left:this.winX+"px",top:this.winY+"px",transform:"translate(-50%, -50%)",zIndex:2e3,background:"#fff",border:"1px solid #333",boxShadow:"0 2px 8px rgba(0,0,0,0.2)"}}},mounted(){this.initializeVisualization(),this.fetchGraphData()},methods:{initializeVisualization(){this.width=window.innerWidth,this.height=window.innerHeight,this.initialX=this.width/3,this.initialY=this.height/12;const e=this.$refs.svg,t=O.Ltv(e).attr("width",this.width).attr("height",this.height);this.svg=t,this.container=this.svg.append("g").attr("transform",`translate(${this.initialX}, ${this.initialY})`),this.zoom=O.s_O().scaleExtent([.5,5]).on("zoom",(e=>{this.container.attr("transform",e.transform)})),t.call(this.zoom),t.call(this.zoom.transform,O.GSI.translate(this.initialX,this.initialY).scale(1))},computeTopoLevels(e,t){const i=new Map(e.map((e=>[e.id,0]))),n=new Map(e.map((e=>[e.id,[]])));t.forEach((e=>{i.set(e.target.id,i.get(e.target.id)+1),n.get(e.source.id).push(e.target.id)}));const s=[];i.forEach(((e,t)=>{0===e&&s.push(t)}));const a=new Map(e.map((e=>[e.id,0])));while(s.length){const e=s.shift();n.get(e).forEach((t=>{i.set(t,i.get(t)-1),0===i.get(t)&&s.push(t),a.set(t,Math.max(a.get(t),a.get(e)+1))}))}return a},async fetchGraphData(){try{const[e,t,i]=await Promise.all([H.A.get(`${W.baseURL}/api/${this.userId}/constructs/`),H.A.get(`${W.baseURL}/api/${this.userId}/entities/`),H.A.get(`${W.baseURL}/api/${this.userId}/triples/`)]);this.entities=t.data,this.triples=i.data,this.totalIndicators=this.entities.length,this.totalTriples=this.triples.length,this.constructs=e.data;const n=this.constructs.map((e=>e.name)),s=this.constructs.map((e=>e.color)),a=this.svg.append("defs");s.forEach((e=>{const t=a.append("marker").attr("id",`arrow-${e.slice(1)}`).attr("markerUnits","userSpaceOnUse").attr("viewBox","0 -5 10 10").attr("refX",6).attr("refY",0).attr("markerWidth",20).attr("markerHeight",20).attr("orient","auto");t.append("path").attr("d","M0,-3L6,0L0,3").attr("fill","currentColor"),t.style("color",e)})),this.colorScale=O.UMr().domain(n).range(s),this.typeOptions=n;const o=i.data,r=t.data.filter((e=>e.construct)),l=new Map(r.map((e=>[e.id,e]))),c=new Map;r.forEach((e=>{const t=e.construct||"unknown";c.has(t)||c.set(t,{id:t,label:t,color:this.colorScale(t)||"#ccc",occurrence:1,size:1})}));const d=new Map;o.forEach((e=>{const t=l.get(e.entity_cause_id),i=l.get(e.entity_effect_id);if(!t||!i)return;const n=t.construct,s=i.construct;if(!n||!s)return;if(n===s)return;let a,o;c.has(n)?(a=c.get(n),a.occurrence+=1,a.size+=1):(a={id:n,label:n,color:this.colorScale(n),occurrence:1,size:1},c.set(n,a)),c.has(s)?(o=c.get(s),o.occurrence+=1,o.size+=1):(o={id:s,label:s,color:this.colorScale(s),occurrence:1,size:1},c.set(s,o));const r=`${n}||${s}`;d.has(r)?d.get(r).value+=1:d.set(r,{source:a,target:o,value:1,distance:1,color:this.colorScale(n)})})),this.nodes=Array.from(c.values()),this.links=Array.from(d.values()),this.totalNodeSize=this.nodes.reduce(((e,t)=>e+t.size),0),this.totalEdgeValue=this.links.reduce(((e,t)=>e+t.value),0),this.parallelGroups=O.Os0(this.links,(e=>[e.source.id,e.target.id].sort().join("|"))),console.log(this.parallelGroups),this.renderGraph()}catch(e){console.error("Error fetching graph data:",e)}},renderGraph(){const e=O.jkA(this.links,(e=>e.value)),t=O.T9B(this.links,(e=>e.value)),i=O.m4Y().domain([e,t]).range([1,5]),n=O.tXi(this.nodes).force("link",O.kJC(this.links).id((e=>e.id)).distance(200)).force("charge",O.xJS().strength(-300)).force("center",O.jTM(250,200)).force("y",O.TSS(this.height/2).strength(.1));this.linkSel=this.container.append("g").attr("class","links").selectAll("path").data(this.links).enter().append("path").attr("fill","none").attr("stroke-width",(e=>i(e.value))).attr("stroke",(e=>e.color)).attr("marker-end",(e=>`url(#arrow-${e.color.slice(1)})`)).attr("stroke-opacity",.6).on("mouseover",((e,t)=>{const i=t.value,n=(i/this.totalEdgeValue*100).toFixed(2),s=`${i}/${this.totalEdgeValue} (${n}%)`;this.tooltipEntities=[{id:"stat",name:s}],this.tooltipStyle={left:e.pageX+12+"px",top:e.pageY-12+"px"},this.showTooltip=!0})).on("mouseout",(()=>{this.showTooltip=!1})).on("click",((e,t)=>this.handleLinkClick(t)));const s=this.container.append("g").attr("class","nodes").selectAll("g").data(this.nodes).enter().append("g").attr("class","node-group").call(O.$Er().on("start",a).on("drag",o).on("end",r));function a(e,t){e.active||n.alphaTarget(.3).restart(),t.fx=t.x,t.fy=t.y}function o(e,t){t.fx=e.x,t.fy=e.y}function r(e,t){e.active||n.alphaTarget(0),t.fx=t.x,t.fy=t.y}this.nodeSel=s,s.append("text").attr("class","node-text").attr("text-anchor","middle").attr("dy",".35em").text((e=>e.label)).style("font-size","14px").style("font-family","Arial").each((function(e){const t=this.getBBox();e.textWidth=t.width,e.textHeight=t.height})),s.insert("rect","text").attr("class","node-rect").attr("fill",(e=>e.color)).attr("x",(e=>-e.textWidth/2-5)).attr("y",(e=>-e.textHeight/2-2)).attr("width",(e=>e.textWidth+10)).attr("height",(e=>e.textHeight+10)),s.on("mouseover",((e,t)=>{const i=t.size,n=(i/this.totalNodeSize*100).toFixed(2),s=`${i}/${this.totalNodeSize} (${n}%)`;this.tooltipEntities=[{id:"stat",name:s}],this.tooltipStyle={left:e.pageX+12+"px",top:e.pageY-12+"px"},this.showTooltip=!0})).on("mouseout",(()=>{this.showTooltip=!1})),s.on("click",((e,t)=>{this.lastClicked===t.id?(this.lastClicked=null,this.resetHighlight()):(this.lastClicked=t.id,this.highlightConstructSingle(t.id)),this.$emit("construct-clicked",t.id)})),n.on("tick",(()=>{this.linkSel.attr("d",(e=>{if(!e.source||!e.target)return"";const t=e.source.x,i=e.source.y,n=e.target.x,s=e.target.y,a=n-t,o=s-i,r=Math.hypot(a,o)||1,l=a/r,c=o/r,d=-c,h=l,u=20,p=t+l*u,g=i+c*u,m=n-l*u,k=s-c*u,f=40,y=[e.source.id,e.target.id].sort().join("|"),v=this.parallelGroups.get(y)||[],w=v.indexOf(e),C=v.length,x=w-(C-1)/2,L=e.source.id<e.target.id?1:-1,I=d*f*x*L,E=h*f*x*L,b=(p+m)/2+I,N=(g+k)/2+E-60;return`M ${p} ${g} Q ${b} ${N} ${m} ${k}`})),s.attr("transform",(e=>`translate(${e.x}, ${e.y})`))}))},handleConstructTooltip(e,t){const i="object"===typeof e&&e.currentTarget?t:e;let n;if(this.tooltipEntities=this.entities.filter((e=>e.construct===i)),n="object"===typeof e&&e.currentTarget?e.currentTarget:this.container.selectAll(".node-group").filter((e=>e.id===i)).node(),n){const e=n.getBoundingClientRect(),t=e.x+e.width+8,i=e.y+e.height/2;this.tooltipStyle={left:`${t}px`,top:`${i}px`}}else console.warn("找不到对应的节点 DOM 元素，用默认位置"),this.tooltipStyle={left:"10px",top:"10px"};this.showTooltip=!0},handleLinkClick(e){const t=e.source.id,i=e.target.id,n=`${e.source.id}||${e.target.id}`;if(this.lastClickedEdgeKey===n)return this.lastClickedEdgeKey=null,this.edgeTableData=[],void this.$emit("triples-highlight",[]);this.lastClickedEdgeKey=n,this.edgeTableHeader=`${e.source.id} ⇒ ${e.target.id}`;const s=this.triples.filter((e=>{const n=this.entities.find((t=>t.id===e.entity_cause_id))?.construct,s=this.entities.find((t=>t.id===e.entity_effect_id))?.construct;return n===t&&s===i})).map((e=>{const t=this.entities.find((t=>t.id===e.entity_cause_id)),i=this.entities.find((t=>t.id===e.entity_effect_id));return{cause:t?t.name:"",effect:i?i.name:""}}));this.edgeTableData=s,this.winX=window.innerWidth/2,this.winY=window.innerHeight/2,this.$emit("triples-highlight",s)},handleZoom(e){ae(e)},startDrag(e){e.target.closest(".window-header")&&(this.dragging=!0,this.dragStartX=e.clientX,this.dragStartY=e.clientY,this.winStartX=this.winX,this.winStartY=this.winY,window.addEventListener("mousemove",this.onDrag),window.addEventListener("mouseup",this.endDrag))},onDrag(e){if(!this.dragging)return;const t=e.clientX-this.dragStartX,i=e.clientY-this.dragStartY;this.winX=this.winStartX+t,this.winY=this.winStartY+i},endDrag(){this.dragging=!1,window.removeEventListener("mousemove",this.onDrag),window.removeEventListener("mouseup",this.endDrag)},highlightConstructSingle(e){this.nodeSel&&this.linkSel&&(this.nodeSel.style("opacity",.1),this.linkSel.style("opacity",.1),this.nodeSel.filter((t=>t.id===e)).style("opacity",1))},resetHighlight(){this.nodeSel&&this.linkSel&&(this.nodeSel.style("opacity",1),this.linkSel.style("opacity",1))},highlightConceptEdge(e,t){this.linkSel.style("opacity",(i=>i.source.id===e&&i.target.id===t?1:.1)),this.nodeSel.style("opacity",(i=>i.id===e||i.id===t?1:.1))},resetConceptHighlight(){this.linkSel.style("opacity",1),this.nodeSel.style("opacity",1)}}};const Ve=(0,l.A)(Pe,[["render",Fe],["__scopeId","data-v-0a523741"]]);var De=Ve;const Oe={key:0,class:"highlight-stats"},He={key:1,class:"validation-overlay"},Ke={class:"validation-errors"},We={class:"container"},je={id:"chart",ref:"chartContainer",class:"chart"},Qe={class:"zoom-container"},Ye={class:"zoom-controls"};function Je(e,t,i,a,o,r){return(0,s.uX)(),(0,s.CE)(s.FK,null,[t[3]||(t[3]=(0,s.Lk)("div",{class:"header-bar"},[(0,s.Lk)("h3",{class:"page-title"},"Node View")],-1)),o.showHighlightStats?((0,s.uX)(),(0,s.CE)("div",Oe,[(0,s.Lk)("p",null,(0,u.v_)(o.highlightedCount)+" / "+(0,u.v_)(o.totalNodeCount)+" ("+(0,u.v_)((o.highlightedCount/o.totalNodeCount*100).toFixed(2))+"%)",1)])):(0,s.Q3)("",!0),Object.keys(o.validationErrors).length>0?((0,s.uX)(),(0,s.CE)("div",He,[(0,s.Lk)("div",Ke,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(o.validationErrors,((e,t)=>((0,s.uX)(),(0,s.CE)("div",{key:t,class:"error-item"},[(0,s.Lk)("p",null,(0,u.v_)(e),1)])))),128)),(0,s.Lk)("button",{onClick:t[0]||(t[0]=(...e)=>r.clearValidationErrors&&r.clearValidationErrors(...e)),class:"close-button"},"close")])])):(0,s.Q3)("",!0),(0,s.Lk)("div",We,[(0,s.Lk)("div",je,null,512)]),(0,s.Lk)("div",Qe,[(0,s.Lk)("div",Ye,[(0,s.bo)((0,s.Lk)("input",{type:"range",min:"10",max:"1000","onUpdate:modelValue":t[1]||(t[1]=e=>o.zoomPercent=e),onInput:t[2]||(t[2]=(...e)=>r.updateZoom&&r.updateZoom(...e))},null,544),[[n.Jo,o.zoomPercent]]),(0,s.Lk)("span",null,(0,u.v_)(o.zoomPercent)+"%",1)])])],64)}var Be={name:"NodeView",emits:["show-instance","graph-updated","close-instance","construct-clicked","edge-clicked","edge-clicked-name","refresh"],data(){return{sourceName:null,nodes:[],links:[],instances:[],svg:null,zoom:null,zoomPercent:40,width:0,height:0,initialX:0,initialY:0,initialPositions:{},selectedNodeName:"",selectedInstances:[],currentIndex:0,simulation:null,mainGroup:null,isInstanceContentVisible:!1,highlightedLegendTypes:[],highlightedCount:0,totalNodeCount:0,showHighlightStats:!1,originalInstances:[],isEditMode:!1,isNodeEditMode:!1,undoStack:[],constructs:[],typeOptions:[],colorScale:null,currentSlideIndex:0,userOperations:[],isCreateNewNode:!1,validationErrors:{},isDirty:!0,showArrows:!1,colorRange:[],highlightLocked:!1,clickedNode:null,clickedLink:null}},props:{userId:{type:String,required:!0},name:{type:String,required:!1},edge:{type:Object,default:null},graphVersion:{type:Number,required:!1},graph:{type:Object,required:!1}},watch:{name:"reloadGraph",edge:"reloadGraph",graphVersion:"reloadGraph"},computed:{displayedInterview(){return this.interviewOptions[this.currentSlideIndex]||""}},async mounted(){this.userOperations=[],this.initializeVisualization(),window.addEventListener("beforeunload",(e=>{this.isDirty&&(e.preventDefault(),e.returnValue="You have unsaved changes. Are you sure you want to leave?")}))},methods:{pauseSimulation(){this.simulation&&(this.simulation.alphaTarget(0),this.simulation.stop())},resumeSimulation(){this.simulation&&this.simulation.restart()},fixNodePosition(e){e.fx=e.x,e.fy=e.y},releaseNodePosition(e){e.fx=null,e.fy=null},initializeVisualization(){const e=this.$refs.chartContainer.getBoundingClientRect(),t=e.width,i=e.width;this.width=t,this.height=i;const n=.4;this.initialX=0,this.initialY=0;const s=O.Ltv(this.$refs.chartContainer).append("svg").attr("width",t).attr("height",i);this.svg=s,this.mainGroup=s.append("g");const a=this.svg.append("defs");this.colorRange.forEach((e=>{a.append("marker").attr("id",`arrow-${e.slice(1)}`).attr("markerUnits","userSpaceOnUse").attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",20).attr("markerHeight",20).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5").attr("fill",e)})),this.zoom=O.s_O().scaleExtent([.1,10]).on("zoom",(e=>{this.mainGroup.attr("transform",e.transform),this.zoomPercent=Math.round(100*e.transform.k),this.handleZoom(e.transform.k)})),s.call(this.zoom),s.call(this.zoom.transform,O.GSI.translate(this.initialX,this.initialY).scale(n))},handleZoom(e){ae(e)},async reloadGraph(){this.mainGroup&&this.mainGroup.selectAll("*").remove(),(this.edge||this.name)&&await this.fetchGraphData()},async fetchGraphData(){try{const[e,t,i]=await Promise.all([H.A.get(`${W.baseURL}/api/${this.userId}/constructs/`),H.A.get(`${W.baseURL}/api/${this.userId}/entities/`),H.A.get(`${W.baseURL}/api/${this.userId}/triples/`)]),n=e.data,s=t.data,a=i.data,o=n.map((e=>e.name));this.colorRange=n.map((e=>e.color)),this.colorScale=O.UMr().domain(o).range(this.colorRange);const r=new Map(s.map((e=>[e.id,e]))),l=new Map,c=new Map;a.forEach((e=>{const t=r.get(e.entity_cause_id),i=r.get(e.entity_effect_id);if(!t||!i)return;const n=t.canonical_entity_id,s=i.canonical_entity_id,a=r.get(n),o=r.get(s);if(!a||!o)return;const d=a.name,h=o.name;l.has(d)||l.set(d,[]),l.get(d).push(h),c.has(h)||c.set(h,[]),c.get(h).push(d)}));const d=this.edge?[this.edge.source,this.edge.target]:[this.name],h=new Set,u=new Set;if(0===d.length)return;const p=(e,t,i)=>{const n=new Set,s=[...e];e.forEach((e=>n.add(e)));while(s.length){const e=s.shift();[t,i].forEach((t=>{(t.get(e)||[]).forEach((e=>{n.has(e)||(n.add(e),s.push(e))}))}))}return n},g=p(d,c,l);h.forEach((e=>g.add(e))),u.forEach((e=>g.add(e)));const m=new Map;g.forEach((e=>{const t=s.find((t=>t.name===e&&t.id===t.canonical_entity_id))||s.find((t=>t.name===e));m.set(e,{id:e,label:e,name:e,construct:t.construct||"unknown",color:this.colorScale(t.construct||"unknown"),occurrence:0,size:0})}));const k=new Map;a.forEach((e=>{const t=r.get(e.entity_cause_id),i=r.get(e.entity_effect_id);if(!t||!i)return;const n=r.get(t.canonical_entity_id).name,s=r.get(i.canonical_entity_id).name;if(!g.has(n)||!g.has(s))return;const a=m.get(n),o=m.get(s);a.occurrence++,a.size++,o.occurrence++,o.size++;const l=`${n}||${s}`;k.has(l)?k.get(l).value++:k.set(l,{source:a,target:o,value:1,distance:1,color:a.color})}));const f=Array.from(m.values()),y=Array.from(k.values()),v={};s.forEach((e=>{const t=r.get(e.canonical_entity_id).name;v[t]||(v[t]=[]),v[t].push(e)})),this.processData(v,f,y)}catch(e){console.error(e)}},processData(e,t,i){this.mainGroup.selectAll("*").remove();const n=t.map((e=>e.size||1)),s=i.map((e=>e.distance||1)),a=i.map((e=>e.value||1)),o=O.Bv9().domain([O.jkA(n),O.T9B(n)]).range([50,100]),r=O.Bv9().domain([O.jkA(s),O.T9B(s)]).range([300,600]),l=O.Bv9().domain([O.jkA(a),O.T9B(a)]).range([10,50]).clamp(!0);this.nodes=t.map((e=>({...e,size:o(e.size),color:e.color||"#cccccc",x:e.x||Math.random()*window.innerWidth,y:e.y||Math.random()*window.innerHeight})));const c=new Map(this.nodes.map((e=>[e.name,e])));this.links=i.map((e=>{const t=c.get(e.source.name),i=c.get(e.target.name);return t&&i?{...e,source:t,target:i,color:e.color||"#999999",distance:r(e.distance),value:e.value,ScaledValue:l(e.value)}:(console.warn("Missing source or target for link:",e),null)})).filter((e=>null!==e)),this.instances=e,this.totalNodeCount=this.nodes.length,this.renderGraph()},renderGraph(){this.simulation=O.tXi(this.nodes).force("link",O.kJC(this.links).id((e=>e.name)).distance((e=>e.distance))).force("charge",O.xJS().strength(0)).force("center",O.jTM(1e3,250)).force("collision",O.eRw().radius((e=>e.size+20))).alpha(1).restart().alphaDecay(.05).on("tick",(()=>this.ticked())),this.updateGraph()},updateGraph(){const e=this.mainGroup.append("g").selectAll("path").data(this.links).enter().append("path").attr("fill","none").attr("stroke-width",(e=>Math.sqrt(e.ScaledValue))).attr("stroke",(e=>e.color)).attr("marker-end",(e=>`url(#arrow-${e.color.slice(1)})`)).on("mouseover",((e,t)=>{this.highlightLocked||this.highlightLink(t)})).on("mouseout",((e,t)=>{this.highlightLocked||this.resetHighlightLink(t)})).on("click",((e,t)=>this.handleLinkClick(t)));e.append("title").text((e=>`Weight: ${e.value}, ${e.target.name} because ${e.source.name}`));const t=this.mainGroup.append("g").selectAll("circle").data(this.nodes).enter().append("circle").attr("r",(e=>e.size)).attr("fill",(e=>e.color)).attr("data-name",(e=>e.name)).attr("cx",(e=>this.initialPositions[e.name]?.x||Math.random()*window.innerWidth)).attr("cy",(e=>this.initialPositions[e.name]?.y||Math.random()*window.innerHeight)).attr("stroke",(e=>O.yWT(e.color).darker(1))).call(O.$Er().filter(((e,t)=>!t.isThirdElement)).on("start",((e,t)=>J(e,t,this.simulation))).on("drag",((e,t)=>{clearTimeout(this.dragTimeout),B.call(this,e,t)})).on("end",((e,t)=>Z(e,t,this.simulation)))).on("click",((e,t)=>{this.onNodeClick(e,t)})).on("mouseover",((e,t)=>{this.highlightLocked||this.highlightNode(t,e,this.mainGroup,[])})).on("mouseout",((e,t)=>{this.highlightLocked||this.resetHighlightNode(t,this.mainGroup,[],(()=>{}),(()=>{}))}));t.append("title").text((e=>`Name: ${e.name}\nConstruct: ${e.construct}`));const i=this.mainGroup.append("g").selectAll("foreignObject").data(this.nodes).enter().append("foreignObject").attr("class","node-label").attr("width",(e=>3*e.size)).attr("height",(e=>3*e.size)).attr("display",(e=>e.isThirdElement?"none":"block")).attr("font-size",(e=>10===e.size?"3px":`${Math.max(e.size/3,10)}px`)).style("pointer-events","none").append("xhtml:div").style("word-wrap","break-word").style("white-space","normal").style("text-align","center").style("display","flex").style("align-items","center").style("justify-content","center").style("height","100%").append("div").style("background-color",(e=>{const t=O.yWT(e.color);return O.Qhc(t.r+40,t.g+40,t.b+40,.8)})).style("color","#000").style("border",(e=>`1px solid ${O.yWT(e.color).darker(1)}`)).style("padding","2px 4px").text((e=>e.name));this.simulation.nodes(this.nodes).on("tick",(()=>this.ticked(e,t,i))),this.simulation.force("link").links(this.links)},updateZoom(){const e=this.zoomPercent/100;if(this.zoom&&O.Ltv("#chart svg")){const t=O.GSI.translate(this.initialX,this.initialY).scale(e);O.Ltv("#chart svg").transition().duration(200).call(this.zoom.transform,t)}else console.error("Zoom or SVG transform is not initialized")},getTextColor(e){return se(e)},highlightNode(e){ee(e,event,this.mainGroup,this.highlightedLegendTypes)},resetHighlightNode(e){te(e,this.mainGroup,this.highlightedLegendTypes,(e=>this.showHighlightStats=e),(e=>this.highlightedCount=e))},highlightLink(e){ie(e,this.mainGroup,this.highlightedLegendTypes)},resetHighlightLink(e){ne(e,this.mainGroup,this.highlightedLegendTypes,(e=>this.showHighlightStats=e),(e=>this.highlightedCount=e))},handleLinkClick(e){if(this.highlightLocked&&(this.clickedLink&&this.clickedLink!==e||this.clickedNode))return;if(this.clickedLink===e)return console.log("cancel"),this.resetHighlightLink(this.mainGroup,[]),this.clickedLink=null,this.highlightLocked=!1,void this.$emit("edge-clicked",null);this.clickedNode&&(this.resetHighlightNode(this.clickedNode,this.mainGroup,[],(()=>{}),(()=>{})),this.clickedNode=null),this.clickedLink&&this.resetHighlightLink(this.mainGroup,[]),this.highlightLink(e,this.mainGroup,[]),this.clickedLink=e,console.log(e),this.highlightLocked=!0;const t={source:e.source.construct||e.source.id,target:e.target.construct||e.target.id};this.$emit("edge-clicked",t)},ticked(){this.mainGroup.selectAll("path").attr("d",(e=>!e.source||!e.target||isNaN(e.source.x)||isNaN(e.source.y)||isNaN(e.target.x)||isNaN(e.target.y)?"":(()=>{const t=e.target.x-e.source.x,i=e.target.y-e.source.y,n=Math.hypot(t,i)||1,s=e.source.size,a=e.target.size,o=e.source.x+t/n*s,r=e.source.y+i/n*s,l=e.target.x-t/n*a,c=e.target.y-i/n*a,d=(o+l)/2,h=(r+c)/2-100;return`M ${o} ${r} Q ${d} ${h} ${l} ${c}`})())),this.mainGroup.selectAll("circle").attr("cx",(e=>isNaN(e.x)?0:e.x)).attr("cy",(e=>isNaN(e.y)?0:e.y)),this.mainGroup.selectAll(".node-label").data(this.nodes).attr("x",(e=>isNaN(e.x)?0:e.x-1.5*e.size)).attr("y",(e=>isNaN(e.y)?0:e.y-1.5*e.size));const e=this.nodes.map((e=>({name:e.name,x:e.x,y:e.y})));localStorage.setItem("nodePositions",JSON.stringify(e))},prevInstance(){this.currentIndex>0&&this.currentIndex--},nextInstance(){this.currentIndex<this.selectedInstances.length-1&&this.currentIndex++},jumpToInterview(e){this.currentSlideIndex=e},goToNodeView(){const e=this.selectedNodeName||this.selectedInstances[this.currentIndex]&&this.selectedInstances[this.currentIndex].name;e?this.$router.push({name:"NodeView",query:{userId:this.userId,id:e}}):console.error("Node name or additional name is not available for navigation")},onNodeClick(e,t){this.highlightLocked&&(this.clickedNode&&this.clickedNode!==t||this.clickedLink)||(this.pauseSimulation(),this.fixNodePosition(t),this.clickedNode===t?(this.resetHighlightNode(t,this.mainGroup,[],(()=>{}),(()=>{})),this.clickedNode=null,this.highlightLocked=!1,this.$emit("construct-clicked",null)):(this.clickedNode&&this.resetHighlightNode(this.clickedNode,this.mainGroup,[],(()=>{}),(()=>{})),this.highlightNode(t,e,this.mainGroup,[]),this.clickedNode=t,this.highlightLocked=!0,this.$emit("construct-clicked",t.construct)),this.selectedNodeName=t.name,this.selectedInstances=this.instances[t.id]||[],this.currentIndex=0,this.$emit("show-instance",{nodeName:this.selectedNodeName,instances:this.selectedInstances,isEditMode:!1,currentIndex:this.currentIndex}),e.stopPropagation())},cancelEdit(){this.isInstanceContentVisible=!1,ue(this)},EditInstance(){xe(this)},addNewInstance(){Le(this)},async saveCurrentInstance(){await Ie(this)},deleteInstance(e){Ee(this,e)},addNewNode(){ve(this)},async saveCurrentNode(){await we(this)},deleteNode(e){Ce(this,e)},undoOperation(){pe(this)},async saveAllOperations(){await ge(this,H.A,W)},showInstanceContent(){me()},hideInstanceContent(){this.isInstanceContentVisible=!1,ue(this)},toggleHighlight(e){oe(e,this.highlightedLegendTypes),this.applyHighlight()},applyHighlight(){re(this.mainGroup,this.nodes,this.highlightedLegendTypes,(e=>this.showHighlightStats=e),(e=>this.highlightedCount=e))},resetHighlight(){console.log("refresh node"),this.clickedNode&&(te(this.clickedNode,this.mainGroup,[],(()=>{}),(()=>{})),this.clickedNode=null),this.clickedLink&&(ne(this.clickedLink,this.mainGroup,[],(()=>{}),(()=>{})),this.clickedLink=null),this.highlightLocked=!1,this.filterLocked=!1,this.highlightedLegendTypes=[],le(this.mainGroup,(()=>this.highlightedCount=0),(()=>this.showHighlightStats=!1))},highlightTriples(e){ce(this.mainGroup,e)},clearValidationErrors(){this.validationErrors={}},prevInterview(){be(this)},nextInterview(){Ne(this)},updateQuestion(){$e()}}};const Ze=(0,l.A)(Be,[["render",Je],["__scopeId","data-v-13d3b7f8"]]);var qe=Ze,et=i.p+"img/previous.75b9b453.svg",tt=i.p+"img/next.051ca4d1.svg";const it={key:0,class:"instance-content"},nt={class:"node-name-container"},st={key:0},at={class:"instance-section"},ot={class:"instance-item"},rt={class:"detail-row"},lt={class:"bullet-title"},ct={class:"aligned"},dt=["value"],ht={class:"detail-row"},ut={class:"bullet-title"},pt={class:"aligned"},gt={key:0},mt={key:1},kt={key:2},ft={key:0,class:"detail-row"},yt={class:"bullet-title"},vt={class:"aligned"},wt={class:"button-container"},Ct={key:0,class:"edit-actions"},xt={class:"pagination"},Lt=["disabled"],It=["disabled"];function Et(e,t,i,a,o,r){return(0,s.uX)(),(0,s.Wv)(n.eB,{name:"fade"},{default:(0,s.k6)((()=>[r.currentEntity?((0,s.uX)(),(0,s.CE)("div",it,[(0,s.Lk)("button",{class:"sidebar-close-button",onClick:t[0]||(t[0]=t=>{e.$emit("cancel-edit"),e.$emit("close")})},"x "),(0,s.Lk)("div",nt,[i.isEditMode&&r.currentEntity.editableName?(0,s.bo)(((0,s.uX)(),(0,s.CE)("textarea",{key:1,"onUpdate:modelValue":t[1]||(t[1]=e=>r.currentEntity.name=e),class:"name-input",placeholder:"Enter node name",style:{height:"40px","font-size":"1.4em","font-weight":"bold","line-height":"1.2"}},null,512)),[[n.Jo,r.currentEntity.name]]):((0,s.uX)(),(0,s.CE)("h3",st,(0,u.v_)(r.currentEntity.name)+" ("+(0,u.v_)(i.currentIndex+1)+" / "+(0,u.v_)(i.instances.length)+") ",1))]),(0,s.Lk)("div",at,[(0,s.Lk)("div",ot,[(0,s.Lk)("div",rt,[(0,s.Lk)("div",lt,[t[13]||(t[13]=(0,s.Lk)("span",{class:"bullet bullet-category"},null,-1)),(0,s.Lk)("p",ct,[t[12]||(t[12]=(0,s.Lk)("strong",null,"Construct: ",-1)),i.isEditMode?(0,s.bo)(((0,s.uX)(),(0,s.CE)("select",{key:1,"onUpdate:modelValue":t[2]||(t[2]=e=>r.currentEntity.construct_id=e),onChange:t[3]||(t[3]=(...e)=>r.onConstructChange&&r.onConstructChange(...e)),class:"edit-input"},[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(i.categoryOptions,(e=>((0,s.uX)(),(0,s.CE)("option",{key:e.id,value:e.id},(0,u.v_)(e.name),9,dt)))),128))],544)),[[n.u1,r.currentEntity.construct_id,void 0,{number:!0}]]):((0,s.uX)(),(0,s.CE)(s.FK,{key:0},[(0,s.eW)((0,u.v_)(r.constructName),1)],64))])])]),(0,s.Lk)("div",ht,[(0,s.Lk)("div",ut,[t[15]||(t[15]=(0,s.Lk)("span",{class:"bullet bullet-participant"},null,-1)),(0,s.Lk)("p",pt,[t[14]||(t[14]=(0,s.Lk)("strong",null,"Sentence: ",-1)),i.isEditMode?(0,s.bo)(((0,s.uX)(),(0,s.CE)("textarea",{key:1,"onUpdate:modelValue":t[4]||(t[4]=e=>r.currentEntity.sentence=e),class:"edit-input",style:{height:"100px","font-size":"16px","line-height":"1.2","font-weight":"normal",color:"#333","font-family":"'Arial', sans-serif"}},"                  ",512)),[[n.Jo,r.currentEntity.sentence]]):((0,s.uX)(),(0,s.CE)(s.FK,{key:0},[r.currentEntity.sentence?((0,s.uX)(),(0,s.CE)("span",gt,(0,u.v_)(r.currentEntity.sentence),1)):o.sentenceText?((0,s.uX)(),(0,s.CE)("span",mt,(0,u.v_)(o.sentenceText),1)):((0,s.uX)(),(0,s.CE)("span",kt,"(Loading...)"))],64))])])]),i.isEditMode||null==r.currentEntity.line_number?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("div",ft,[(0,s.Lk)("div",yt,[t[17]||(t[17]=(0,s.Lk)("span",{class:"bullet bullet-type"},null,-1)),(0,s.Lk)("p",vt,[t[16]||(t[16]=(0,s.Lk)("strong",null,"Sentence Line Number：",-1)),(0,s.eW)(" "+(0,u.v_)(r.currentEntity.line_number),1)])])]))])]),(0,s.Lk)("div",wt,[i.isEditMode?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("button",{key:0,class:"edit-button",onClick:t[5]||(t[5]=t=>e.$emit("edit-instance"))},"Edit")),i.isEditMode?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("button",{key:1,class:"add-button",onClick:t[6]||(t[6]=t=>e.$emit("add-new-instance"))},"Add")),i.isEditMode?(0,s.Q3)("",!0):((0,s.uX)(),(0,s.CE)("button",{key:2,class:"delete-button",onClick:t[7]||(t[7]=t=>e.$emit("delete-instance",i.currentIndex))},"Delete"))]),i.isEditMode?((0,s.uX)(),(0,s.CE)("div",Ct,[(0,s.Lk)("button",{onClick:t[8]||(t[8]=t=>e.$emit("save"))},"Save"),(0,s.Lk)("button",{onClick:t[9]||(t[9]=t=>e.$emit("cancel-edit"))},"Cancel")])):(0,s.Q3)("",!0),(0,s.Lk)("div",xt,[(0,s.Lk)("button",{onClick:t[10]||(t[10]=t=>e.$emit("prev-instance")),disabled:0===i.currentIndex},t[18]||(t[18]=[(0,s.Lk)("img",{src:et,alt:"Previous",class:"icon"},null,-1)]),8,Lt),(0,s.Lk)("button",{onClick:t[11]||(t[11]=t=>e.$emit("next-instance")),disabled:i.currentIndex===i.instances.length-1},t[19]||(t[19]=[(0,s.Lk)("img",{src:tt,alt:"Next",class:"icon"},null,-1)]),8,It)])])):(0,s.Q3)("",!0)])),_:1})}var bt={name:"InstanceContent",props:{instances:{type:Array,default:()=>[]},currentIndex:{type:Number,required:!0},isEditMode:{type:Boolean,default:!1},categoryOptions:{type:Array,default:()=>[]},userId:{type:String,required:!0}},data(){return{sentenceText:"",sentenceLineNumber:null,editSentence:""}},computed:{currentEntity(){return this.instances[this.currentIndex]||null},constructName(){const e=this.currentEntity?.construct_id;if(null!=e){const t=this.categoryOptions.find((t=>t.id===e));if(t)return t.name}return this.currentEntity?.construct||""}},watch:{currentEntity:{handler(e){e&&e.sentence_id?this.fetchSentenceText(e.sentence_id):this.sentenceText=""},immediate:!0},isEditMode(e){e&&(this.editSentence=this.sentenceText)}},mounted(){},methods:{async fetchSentenceText(e){try{const{data:t}=await H.A.get(`${W.baseURL}/api/sentence/${e}/`);this.sentenceText=t.text||"",this.currentEntity.sentence??=this.sentenceText,this.currentEntity.line_number=null!=t.line_number?t.line_number:null}catch(t){console.error(t),this.sentenceText="(加载失败)"}},onConstructChange(){const e=this.currentEntity.construct_id,t=this.categoryOptions.find((t=>t.id===e));this.currentEntity.construct=t?t.name:""}}};const Nt=(0,l.A)(bt,[["render",Et]]);var $t=Nt;const St={class:"memo-widget"},_t=["src"],At={key:0,class:"memo-panel"};function zt(e,t,i,a,o,r){return(0,s.uX)(),(0,s.CE)("div",St,[(0,s.Lk)("button",{class:"memo-toggle",onClick:t[0]||(t[0]=(...e)=>r.toggleOpen&&r.toggleOpen(...e))},[(0,s.Lk)("img",{src:o.MemoIcon,alt:"memo",class:"memo-icon"},null,8,_t)]),o.open?((0,s.uX)(),(0,s.CE)("div",At,[(0,s.bo)((0,s.Lk)("textarea",{"onUpdate:modelValue":t[1]||(t[1]=e=>o.memo=e),onInput:t[2]||(t[2]=(...e)=>r.saveMemo&&r.saveMemo(...e)),onBlur:t[3]||(t[3]=(...e)=>r.saveMemo&&r.saveMemo(...e)),placeholder:"Take notes here..."},null,544),[[n.Jo,o.memo]])])):(0,s.Q3)("",!0)])}var Tt=i.p+"img/memo.67261dfb.svg",Mt={name:"MemoWidget",data(){return{open:!1,memo:"",MemoIcon:Tt}},mounted(){const e=localStorage.getItem("userMemo");null!==e&&(this.memo=e)},watch:{memo(e){localStorage.setItem("userMemo",e)}},beforeUnmount(){localStorage.setItem("userMemo",this.memo)},methods:{toggleOpen(){this.open=!this.open,this.open||this.saveMemo()},saveMemo(){localStorage.setItem("userMemo",this.memo)}}};const Rt=(0,l.A)(Mt,[["render",zt],["__scopeId","data-v-8d68a32a"]]);var Xt=Rt,Ut=i.p+"img/color.9ad1b3e2.svg",Gt=i(6023);const Ft={class:"construct-widget"},Pt=["src"],Vt={key:0,class:"panel"},Dt={class:"construct-list"},Ot={class:"construct-header"},Ht=["onClick"],Kt={class:"construct-title"},Wt={class:"header-right"},jt={class:"color-picker-wrapper"},Qt=["onUpdate:modelValue","onInput"],Yt=["onClick"],Jt={key:0,class:"construct-fields"},Bt={class:"field-row row-name"},Zt={class:"field-right"},qt=["onUpdate:modelValue","onKeyup"],ei=["src","onClick"],ti={class:"field-text"},ii=["src","onClick"],ni={class:"field-row row-definition"},si={class:"field-right"},ai=["onUpdate:modelValue","onKeyup"],oi=["src","onClick"],ri={class:"field-text"},li=["src","onClick"],ci={class:"field-row row-examples"},di={class:"field-right"},hi={class:"tags-input"},ui=["onClick"],pi=["onUpdate:modelValue","onKeyup"],gi=["src","onClick"],mi={class:"tags-display"},ki=["src","onClick"],fi={class:"add-construct"},yi={key:1,class:"new-construct-form"},vi={class:"form-actions"},wi={class:"re-visualize",style:{"margin-top":"12px","text-align":"center"}};function Ci(e,t,i,a,o,r){return(0,s.uX)(),(0,s.CE)("div",Ft,[(0,s.Lk)("button",{class:"toggle-button",onClick:t[0]||(t[0]=(...e)=>r.toggleOpen&&r.toggleOpen(...e))},[(0,s.Lk)("img",{src:o.ConstructIcon,alt:"construct",class:"toggle-icon"},null,8,Pt)]),o.open?((0,s.uX)(),(0,s.CE)("div",Vt,[t[16]||(t[16]=(0,s.Lk)("h3",null,"Concepts",-1)),(0,s.Lk)("ul",Dt,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(o.constructs,(i=>((0,s.uX)(),(0,s.CE)("li",{key:i.id,class:"construct-item"},[(0,s.Lk)("div",Ot,[(0,s.Lk)("div",{class:"header-left",onClick:e=>r.toggleExpand(i)},[(0,s.Lk)("i",{class:(0,u.C4)(["arrow",i.expanded?"down":"right"])},null,2),(0,s.Lk)("span",Kt,(0,u.v_)(i.name),1)],8,Ht),(0,s.Lk)("div",Wt,[(0,s.Lk)("span",{class:"color-block",style:(0,u.Tr)({backgroundColor:i.color||"#ff0000"})},null,4),(0,s.Lk)("div",jt,[t[10]||(t[10]=(0,s.Lk)("img",{src:Ut,class:"icon-color-picker"},null,-1)),(0,s.bo)((0,s.Lk)("input",{type:"color","onUpdate:modelValue":e=>i.color=e,onInput:e=>r.updateColor(i),class:"color-input"},null,40,Qt),[[n.Jo,i.color]])]),(0,s.Lk)("img",{src:Gt,class:"icon-delete",onClick:e=>r.deleteConstruct(i.id)},null,8,Yt)])]),i.expanded?((0,s.uX)(),(0,s.CE)("div",Jt,[(0,s.Lk)("div",Bt,[t[11]||(t[11]=(0,s.Lk)("div",{class:"field-left"},"Name:",-1)),(0,s.Lk)("div",Zt,["name"===i.editingField?((0,s.uX)(),(0,s.CE)(s.FK,{key:0},[(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":e=>i.name=e,onKeyup:(0,n.jR)((e=>r.saveField(i,"name")),["enter"]),class:"field-input"},null,40,qt),[[n.Jo,i.name]]),(0,s.Lk)("img",{src:o.CheckIcon,class:"icon-check",onClick:e=>r.saveField(i,"name"),alt:"save"},null,8,ei)],64)):((0,s.uX)(),(0,s.CE)(s.FK,{key:1},[(0,s.Lk)("span",ti,(0,u.v_)(i.name),1),(0,s.Lk)("img",{src:o.ReviseIcon,class:"icon-pencil",onClick:(0,n.D$)((e=>r.startFieldEdit(i,"name")),["stop"]),alt:"edit"},null,8,ii)],64))])]),t[14]||(t[14]=(0,s.Lk)("hr",null,null,-1)),(0,s.Lk)("div",ni,[t[12]||(t[12]=(0,s.Lk)("div",{class:"field-left"},"Definition:",-1)),(0,s.Lk)("div",si,["definition"===i.editingField?((0,s.uX)(),(0,s.CE)(s.FK,{key:0},[(0,s.bo)((0,s.Lk)("textarea",{"onUpdate:modelValue":e=>i.definition=e,autofocus:"",onFocus:t[1]||(t[1]=t=>e.autoGrow(t)),onInput:t[2]||(t[2]=t=>e.autoGrow(t)),onKeyup:(0,n.jR)((e=>r.saveField(i,"definition")),["enter"]),class:"field-textarea"},null,40,ai),[[n.Jo,i.definition]]),(0,s.Lk)("img",{src:o.CheckIcon,class:"icon-check",onClick:e=>r.saveField(i,"definition"),alt:"save"},null,8,oi)],64)):((0,s.uX)(),(0,s.CE)(s.FK,{key:1},[(0,s.Lk)("span",ri,(0,u.v_)(i.definition),1),(0,s.Lk)("img",{src:o.ReviseIcon,class:"icon-pencil",onClick:(0,n.D$)((e=>r.startFieldEdit(i,"definition")),["stop"]),alt:"edit"},null,8,li)],64))])]),t[15]||(t[15]=(0,s.Lk)("hr",null,null,-1)),(0,s.Lk)("div",ci,[t[13]||(t[13]=(0,s.Lk)("div",{class:"field-left"},"Reference(s):",-1)),(0,s.Lk)("div",di,["examples"===i.editingField?((0,s.uX)(),(0,s.CE)(s.FK,{key:0},[(0,s.Lk)("div",hi,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(i.examples,((e,t)=>((0,s.uX)(),(0,s.CE)("span",{key:t,class:"tag"},[(0,s.eW)((0,u.v_)(e)+" ",1),(0,s.Lk)("i",{class:"tag-remove",onClick:e=>r.removeExample(i,t)},"×",8,ui)])))),128)),i.examples.length<3?(0,s.bo)(((0,s.uX)(),(0,s.CE)("input",{key:0,"onUpdate:modelValue":e=>o.newExample[i.id]=e,class:"tag-input",placeholder:"Type & Enter to add",onKeyup:(0,n.jR)((e=>r.addExample(i)),["enter"])},null,40,pi)),[[n.Jo,o.newExample[i.id]]]):(0,s.Q3)("",!0)]),(0,s.Lk)("img",{src:o.CheckIcon,class:"icon-check",onClick:e=>r.saveExamples(i),alt:"save"},null,8,gi)],64)):((0,s.uX)(),(0,s.CE)(s.FK,{key:1},[(0,s.Lk)("div",mi,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(i.examples,((e,t)=>((0,s.uX)(),(0,s.CE)("span",{key:t,class:"tag"},(0,u.v_)(e),1)))),128))]),(0,s.Lk)("img",{src:o.ReviseIcon,class:"icon-pencil",onClick:(0,n.D$)((e=>r.startFieldEdit(i,"examples")),["stop"]),alt:"edit"},null,8,ki)],64))])])])):(0,s.Q3)("",!0)])))),128))]),(0,s.Lk)("div",fi,[o.addingConstruct?((0,s.uX)(),(0,s.CE)("div",yi,[(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":t[4]||(t[4]=e=>o.newC.name=e),placeholder:"Name",class:"field-input"},null,512),[[n.Jo,o.newC.name]]),(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":t[5]||(t[5]=e=>o.newC.definition=e),placeholder:"Definition",class:"field-input"},null,512),[[n.Jo,o.newC.definition]]),(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":t[6]||(t[6]=e=>o.newC.examplesStr=e),placeholder:"Examples (comma-separated)",class:"field-input"},null,512),[[n.Jo,o.newC.examplesStr]]),(0,s.Lk)("div",vi,[(0,s.Lk)("button",{onClick:t[7]||(t[7]=(...e)=>r.createConstruct&&r.createConstruct(...e)),class:"btn-small"},"Create"),(0,s.Lk)("button",{onClick:t[8]||(t[8]=(...e)=>r.cancelCreate&&r.cancelCreate(...e)),class:"btn-small"},"Cancel")])])):((0,s.uX)(),(0,s.CE)("button",{key:0,onClick:t[3]||(t[3]=e=>o.addingConstruct=!0),class:"btn-add"},"＋ Add Construct"))]),(0,s.Lk)("div",wi,[(0,s.Lk)("button",{onClick:t[9]||(t[9]=(...e)=>r.startVisualise&&r.startVisualise(...e)),class:"btn-next"},"Re-visualize")])])):(0,s.Q3)("",!0)])}var xi=i(5947),Li=i.n(xi),Ii=i.p+"img/construct.01510f82.svg",Ei=i.p+"img/check.8d11a380.svg",bi=i.p+"img/revise.21f676db.svg",Ni={name:"ConstructWidget",data(){return{open:!1,constructs:[],addingConstruct:!1,newC:{name:"",definition:"",examplesStr:""},newExample:{},ConstructIcon:Ii,CheckIcon:Ei,ReviseIcon:bi}},mounted(){this.fetchConstructs()},methods:{toggleOpen(){this.open=!this.open},async fetchConstructs(){const e=localStorage.getItem("userId"),{data:t}=await H.A.get(`${W.baseURL}/api/constructs/all/${e}/`);this.constructs=t.constructs.map((e=>({...e,examples:e.examples||[],expanded:!1,showPicker:!1})))},toggleExpand(e){e.expanded=!e.expanded,e.expanded||(e.editingField=null)},async createConstruct(){const e=this.newC.name.trim(),t=this.newC.definition.trim();if(!e||!t){const e="Please fill in both Name and Definition before creating.";return this.$toast?this.$toast.error(e):alert(e)}const i=Number(localStorage.getItem("userId"));await H.A.post(`${W.baseURL}/api/upload_constructs/`,{user_id:i,constructs:[{name:this.newC.name,definition:this.newC.definition,examples:this.newC.examplesStr.split(",").map((e=>e.trim())).filter((e=>e))}]}),this.addingConstruct=!1,this.newC={name:"",definition:"",examplesStr:""},this.fetchConstructs()},cancelCreate(){this.addingConstruct=!1,this.newC={name:"",definition:"",examplesStr:""}},startFieldEdit(e,t){e.editingField=t,this.newExample=""},addExample(e){const t=this.newExample.trim();if(t){if(e.examples.length>=3){const e="You can only add up to 3 examples";return this.$toast?this.$toast.error(e):alert(e)}e.examples.push(t),this.newExample=""}},removeExample(e,t){e.examples.splice(t,1)},async saveExamples(e){const t=this.newExample.trim();t&&(e.examples.push(t),this.newExample=""),await this.saveField(e,"examples")},async saveField(e,t){delete e.editingField;const i={name:e.name,definition:e.definition,examples:e.examples};await H.A.post(`${W.baseURL}/api/constructs/update/${e.id}/`,{[t]:i[t]})},async deleteConstruct(e){await H.A.post(`${W.baseURL}/api/constructs/delete/${e}/`),this.fetchConstructs()},async updateColor(e){await H.A.post(`${W.baseURL}/api/constructs/update/${e.id}/`,{color:e.color})},async startVisualise(){const e=Number(localStorage.getItem("userId"));if(!e)return alert("Missing user ID");Li().start();try{await H.A.post(`${W.baseURL}/api/map_constructs/`,{user_id:e,force:!1}),Li().set(.25),await H.A.post(`${W.baseURL}/api/extract_causals/`,{user_id:e}),Li().set(.5),await H.A.post(`${W.baseURL}/api/auto_entity_resolution/`,{user_id:e}),Li().set(.75),await H.A.get(`${W.baseURL}/api/import-data/`,{params:{user_id:e}}),Li().done(),window.confirm("All processing steps completed! Refresh the page?")&&window.location.reload()}catch(t){Li().done(),console.error(t),alert("Processing failed: "+(t.response?.data?.message||t.message))}}}};const $i=(0,l.A)(Ni,[["render",Ci],["__scopeId","data-v-b6defa4e"]]);var Si=$i,_i={name:"HomePage",components:{Main:Te,TheoryView:De,NodeView:qe,InstanceContent:$t,MemoWidget:Xt,ConstructWidget:Si},data(){return{userId:localStorage.getItem("userId")||34,leftWidth:window.innerWidth/7*3,middleWidth:window.innerWidth/3,selectedNodeName:"",startX:0,isDragging:!1,showSidebar:!1,sidebarNode:"",sidebarInstances:[],currentIndex:0,isEditMode:!1,constructs:[],graphVersion:0,selectedConstruct:null,clickedEdge:null,clickedEdgeName:null}},watch:{userId(e){e?localStorage.setItem("userId",e):localStorage.removeItem("userId")}},computed:{gridStyles(){return{gridTemplateColumns:`${this.leftWidth}px 5px ${this.middleWidth}px auto`}}},mounted(){this.currentIndex=this.$refs.mainComp.currentIndex},methods:{onGraphUpdated(){this.graphVersion++},handleNodeSelected(e){this.selectedNodeName=e},handleShowInstance(e){this.sidebarNode=e.nodeName,this.sidebarInstances=e.instances,this.currentIndex=e.currentIndex,this.isEditMode=e.isEditMode,this.showSidebar=!0},startDrag(e){this.isDragging=!0,this.startX=e.clientX,document.addEventListener("mousemove",this.onDragging),document.addEventListener("mouseup",this.stopDrag)},onDragging(e){if(!this.isDragging)return;const t=e.clientX-this.startX;this.leftWidth+=t,this.startX=e.clientX},stopDrag(){this.isDragging=!1,document.removeEventListener("mousemove",this.onDragging),document.removeEventListener("mouseup",this.stopDrag)},onEditInstance(){this.isEditMode=!0,this.$refs.mainComp.EditInstance()},onCancelEdit(){this.isEditMode=!1,this.$refs.mainComp.cancelEdit()},onAddNewInstance(){this.isEditMode=!0,this.$refs.mainComp.addNewInstance()},onDeleteInstance(e){this.$refs.mainComp.deleteInstance(e),0===this.sidebarInstances.length&&(this.showSidebar=!1)},async onSaveInstance(){const e=this.sidebarInstances[this.currentIndex];console.log(this.sidebarInstances),console.log(e.isNew),e.isNew?await this.$refs.mainComp.saveCurrentNode():await this.$refs.mainComp.saveCurrentInstance(),this.isEditMode=!1},onConstructClicked(e){this.selectedConstruct=e,console.log(this.selectedConstruct)},onEdgeClicked(e){null!==e?this.clickedEdge&&this.clickedEdge.source===e.source&&this.clickedEdge.target===e.target?this.clickedEdge=null:this.clickedEdge=e:this.clickedEdge=null},onEdgeClickedName(e){this.clickedEdgeName=e},handleConceptClicked(e){const t=this.$refs.mainComp,i=this.$refs.nodeComp;t&&i&&(e?(t.toggleHighlight(e),i.toggleHighlight(e)):(t.resetHighlight(),i.resetHighlight()))},handleTriples(e){const t=this.$refs.mainComp,i=this.$refs.nodeComp;t&&t.highlightTriples(e),i&&i.highlightTriples(e)},onRefresh(){this.$refs.conceptComp.resetHighlight(),this.$refs.nodeComp.resetHighlight()}}};const Ai=(0,l.A)(_i,[["render",y],["__scopeId","data-v-0927a6b6"]]);var zi=Ai;const Ti={class:"entity-construct-page"},Mi={key:0,class:"global-error"},Ri={class:"id-bar"},Xi=["disabled"],Ui={key:1,class:"upload-bar"},Gi=["disabled"],Fi={class:"info"},Pi={key:2,class:"panels"},Vi={class:"left-panel"},Di={class:"entity-table"},Oi=["rowspan"],Hi={class:"indicator-col"},Ki={class:"entity-name-cell"},Wi={key:0,class:"name-text"},ji=["onKeyup"],Qi=["src","onClick"],Yi=["src"],Ji={class:"name-text"},Bi=["src","onClick"],Zi=["src","onClick"],qi=["onUpdate:modelValue","onChange","disabled"],en=["value"],tn={key:0,class:"pagination-controls"},nn=["value"],sn=["disabled"],an=["src"],on=["disabled"],rn=["src"],ln={class:"right-panel"},cn={class:"overview-container"},dn={class:"overview-edit"},hn=["disabled"],un=["src"],pn={class:"construct-list"},gn={class:"construct-header"},mn=["onClick"],kn={class:"construct-title"},fn={class:"header-right"},yn={class:"color-picker-wrapper"},vn=["src","onClick"],wn=["onUpdate:modelValue","onChange"],Cn=["src","onClick"],xn={key:0,class:"construct-fields"},Ln={class:"field-row row-name"},In={class:"field-right"},En=["onUpdate:modelValue","onKeyup"],bn=["src","onClick"],Nn={class:"field-text"},$n=["src","onClick"],Sn={class:"field-row row-definition"},_n={class:"field-right"},An=["onUpdate:modelValue","onKeyup"],zn=["src","onClick"],Tn={class:"field-text"},Mn=["src","onClick"],Rn={class:"field-row row-examples"},Xn={class:"field-right"},Un={class:"tags-input"},Gn=["onClick"],Fn=["onKeyup"],Pn=["src","onClick"],Vn={class:"tags-display"},Dn=["src","onClick"],On={class:"add-construct"},Hn={key:1,class:"new-construct-form"},Kn={class:"form-actions"},Wn={class:"next-step"},jn={class:"button-wrapper"},Qn=["disabled"],Yn={key:0,class:"custom-tooltip"};function Jn(e,t,i,a,o,r){const l=(0,s.g2)("MemoWidget");return(0,s.uX)(),(0,s.CE)("div",Ti,[o.userNotExist?((0,s.uX)(),(0,s.CE)("div",Mi," 🥲 The user does not exist. Please check whether the User ID is correct. ")):(0,s.Q3)("",!0),t[36]||(t[36]=(0,s.Lk)("div",{class:"welcome"},[(0,s.Lk)("h2",null,"Welcome to Our Visualization System!"),(0,s.Lk)("p",null,"🤩 Please upload the qualitative data you’d like to visualize in .txt format. The file should contain one sentence per line.")],-1)),(0,s.Lk)("div",Ri,[t[25]||(t[25]=(0,s.Lk)("label",null,"User ID:",-1)),(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>o.userId=e),type:"number",placeholder:"Enter user ID",class:"user-input"},null,512),[[n.Jo,o.userId]]),(0,s.Lk)("button",{disabled:!o.userId,onClick:t[1]||(t[1]=(...e)=>r.initUser&&r.initUser(...e)),class:"btn-small"}," Confirm ",8,Xi),(0,s.Lk)("button",{onClick:t[2]||(t[2]=(...e)=>r.registerUser&&r.registerUser(...e)),class:"btn-small"}," Register ")]),o.userConfirmed?((0,s.uX)(),(0,s.CE)("div",Ui,[(0,s.Lk)("input",{type:"file",accept:".txt",onChange:t[3]||(t[3]=(...e)=>r.onFileChange&&r.onFileChange(...e))},null,32),(0,s.Lk)("button",{disabled:!o.txtFile,onClick:t[4]||(t[4]=(...e)=>r.uploadEntities&&r.uploadEntities(...e)),class:"btn-upload-green"}," Import & Extract ",8,Gi),(0,s.Lk)("span",Fi,(0,u.v_)(o.uploadInfo),1)])):(0,s.Q3)("",!0),o.userConfirmed?((0,s.uX)(),(0,s.CE)("div",Pi,[(0,s.Lk)("div",Vi,[(0,s.Lk)("table",Di,[t[27]||(t[27]=(0,s.Lk)("thead",null,[(0,s.Lk)("tr",null,[(0,s.Lk)("th",null,"No."),(0,s.Lk)("th",null,"Sentence"),(0,s.Lk)("th",{class:"indicator-col"},"Indicator"),(0,s.Lk)("th",null,"Concept")])],-1)),(0,s.Lk)("tbody",null,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(r.stripedEntities,((e,i)=>((0,s.uX)(),(0,s.CE)("tr",{key:e.id,class:(0,u.C4)({stripe:e._stripe})},[(0,s.Lk)("td",null,(0,u.v_)((o.currentPage-1)*o.pageSize+i+1),1),e._showSentence?((0,s.uX)(),(0,s.CE)("td",{key:0,rowspan:e._rowspan,class:"sentence-cell",onMouseup:t[5]||(t[5]=(...e)=>r.onSentenceMouseUp&&r.onSentenceMouseUp(...e))},(0,u.v_)(e.sentence),41,Oi)):(0,s.Q3)("",!0),(0,s.Lk)("td",Hi,[(0,s.Lk)("div",Ki,[e.placeholder?((0,s.uX)(),(0,s.CE)("div",Wi,"–")):o.entityEditingId===e.id?((0,s.uX)(),(0,s.CE)(s.FK,{key:1},[(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":t[6]||(t[6]=e=>o.entityNewName=e),onKeyup:(0,n.jR)((t=>r.saveEntityName(e)),["enter"]),class:"inline-input"},null,40,ji),[[n.Jo,o.entityNewName]]),(0,s.Lk)("img",{src:o.CheckIcon,class:"icon-check",onClick:t=>r.saveEntityName(e),alt:"Save"},null,8,Qi),(0,s.Lk)("img",{src:o.CloseIcon,class:"icon-close",onClick:t[7]||(t[7]=(...e)=>r.cancelEntityEdit&&r.cancelEntityEdit(...e)),alt:"Cancel",title:"Cancel edit"},null,8,Yi)],64)):((0,s.uX)(),(0,s.CE)(s.FK,{key:2},[(0,s.Lk)("div",Ji,(0,u.v_)(e.name),1),(0,s.Lk)("img",{src:o.ReviseIcon,class:"icon-pencil",onClick:t=>r.startEntityEdit(e),alt:"Edit"},null,8,Bi),(0,s.Lk)("img",{src:o.DeleteIcon,class:"icon-delete",onClick:t=>r.onDeleteEntity(e),alt:"Delete"},null,8,Zi)],64))])]),(0,s.Lk)("td",null,[(0,s.bo)((0,s.Lk)("select",{"onUpdate:modelValue":t=>e.construct_id=t,onChange:t=>r.assignConstruct(e),disabled:e.placeholder},[t[26]||(t[26]=(0,s.Lk)("option",{value:""},"–",-1)),((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(o.constructs,(e=>((0,s.uX)(),(0,s.CE)("option",{key:e.id,value:e.id},(0,u.v_)(e.name),9,en)))),128))],40,qi),[[n.u1,e.construct_id]])])],2)))),128))])]),o.uploaded?((0,s.uX)(),(0,s.CE)("div",tn,[t[28]||(t[28]=(0,s.Lk)("label",null,"Items per page:",-1)),(0,s.bo)((0,s.Lk)("select",{"onUpdate:modelValue":t[8]||(t[8]=e=>o.pageSize=e)},[((0,s.uX)(),(0,s.CE)(s.FK,null,(0,s.pI)([10,20,50,100],(e=>(0,s.Lk)("option",{key:e,value:e},(0,u.v_)(e),9,nn))),64))],512),[[n.u1,o.pageSize,void 0,{number:!0}]]),(0,s.Lk)("button",{onClick:t[9]||(t[9]=(...e)=>r.prevPage&&r.prevPage(...e)),disabled:1===o.currentPage,class:"pagination-button"},[(0,s.Lk)("img",{src:o.PreviousIcon,alt:"Previous",class:"pagination-icon"},null,8,an)],8,sn),(0,s.Lk)("span",null,(0,u.v_)(o.currentPage)+" / "+(0,u.v_)(r.pageCount),1),(0,s.Lk)("button",{onClick:t[10]||(t[10]=(...e)=>r.nextPage&&r.nextPage(...e)),disabled:o.currentPage===r.pageCount,class:"pagination-button"},[(0,s.Lk)("img",{src:o.NextIcon,alt:"Next",class:"pagination-icon"},null,8,rn)],8,on)])):(0,s.Q3)("",!0)]),(0,s.Lk)("div",ln,[(0,s.Lk)("div",cn,[t[29]||(t[29]=(0,s.Lk)("h3",null,"Research Overview",-1)),(0,s.Lk)("div",dn,[(0,s.bo)((0,s.Lk)("textarea",{id:"overview","onUpdate:modelValue":t[11]||(t[11]=e=>o.researchOverview=e),placeholder:"Help us improve indicator extraction by briefly describing what your research is about and the kind of data you're working with.",rows:"4"},null,512),[[n.Jo,o.researchOverview]]),(0,s.Lk)("button",{type:"button",class:"overview-save-btn",onClick:t[12]||(t[12]=(...e)=>r.saveResearchOverview&&r.saveResearchOverview(...e)),disabled:o.savingOverview,title:"Save overview"},[(0,s.Lk)("img",{src:o.CheckIcon,alt:"Save"},null,8,un)],8,hn)])]),t[35]||(t[35]=(0,s.Lk)("h3",null,"Concepts",-1)),(0,s.Lk)("ul",pn,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(o.constructs,(e=>((0,s.uX)(),(0,s.CE)("li",{key:e.id,class:"construct-item"},[(0,s.Lk)("div",gn,[(0,s.Lk)("div",{class:"header-left",onClick:t=>r.toggleExpand(e)},[(0,s.Lk)("i",{class:(0,u.C4)(["arrow",e.expanded?"down":"right"])},null,2),(0,s.Lk)("span",kn,(0,u.v_)(e.name),1)],8,mn),(0,s.Lk)("div",fn,[(0,s.Lk)("span",{class:"color-block",style:(0,u.Tr)({backgroundColor:e.color||"#ff0000"})},null,4),(0,s.Lk)("div",yn,[(0,s.Lk)("img",{src:o.ColorIcon,class:"icon-color-picker",alt:"pick color",onClick:(0,n.D$)((t=>e.showPicker=!e.showPicker),["stop"]),title:"Change color"},null,8,vn),(0,s.bo)((0,s.Lk)("input",{type:"color","onUpdate:modelValue":t=>e.color=t,onChange:t=>r.updateColor(e),class:"color-input"},null,40,wn),[[n.aG,e.showPicker],[n.Jo,e.color]])]),(0,s.Lk)("img",{src:o.DeleteIcon,class:"icon-delete",alt:"delete",onClick:(0,n.D$)((t=>r.doDelete(e.id)),["stop"])},null,8,Cn)])]),e.expanded?((0,s.uX)(),(0,s.CE)("div",xn,[(0,s.Lk)("div",Ln,[t[30]||(t[30]=(0,s.Lk)("div",{class:"field-left"}," Name: ",-1)),(0,s.Lk)("div",In,["name"===e.editingField?((0,s.uX)(),(0,s.CE)(s.FK,{key:0},[(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":t=>e.name=t,onKeyup:(0,n.jR)((t=>r.saveField(e,"name")),["enter"]),class:"field-input"},null,40,En),[[n.Jo,e.name]]),(0,s.Lk)("img",{src:o.CheckIcon,class:"icon-check",onClick:t=>r.saveField(e,"name"),alt:"save"},null,8,bn)],64)):((0,s.uX)(),(0,s.CE)(s.FK,{key:1},[(0,s.Lk)("span",Nn,(0,u.v_)(e.name),1),(0,s.Lk)("img",{src:o.ReviseIcon,class:"icon-pencil",onClick:(0,n.D$)((t=>r.startFieldEdit(e,"name")),["stop"]),alt:"edit"},null,8,$n)],64))])]),t[33]||(t[33]=(0,s.Lk)("hr",null,null,-1)),(0,s.Lk)("div",Sn,[t[31]||(t[31]=(0,s.Lk)("div",{class:"field-left"}," Definition: ",-1)),(0,s.Lk)("div",_n,["definition"===e.editingField?((0,s.uX)(),(0,s.CE)(s.FK,{key:0},[(0,s.bo)((0,s.Lk)("textarea",{"onUpdate:modelValue":t=>e.definition=t,autofocus:"",onFocus:t[13]||(t[13]=e=>r.autoGrow(e)),onInput:t[14]||(t[14]=e=>r.autoGrow(e)),onKeyup:(0,n.jR)((t=>r.saveField(e,"definition")),["enter"]),class:"field-textarea"},null,40,An),[[n.Jo,e.definition]]),(0,s.Lk)("img",{src:o.CheckIcon,class:"icon-check",onClick:t=>r.saveField(e,"definition"),alt:"save"},null,8,zn)],64)):((0,s.uX)(),(0,s.CE)(s.FK,{key:1},[(0,s.Lk)("span",Tn,(0,u.v_)(e.definition),1),(0,s.Lk)("img",{src:o.ReviseIcon,class:"icon-pencil",onClick:(0,n.D$)((t=>r.startFieldEdit(e,"definition")),["stop"]),alt:"edit"},null,8,Mn)],64))])]),t[34]||(t[34]=(0,s.Lk)("hr",null,null,-1)),(0,s.Lk)("div",Rn,[t[32]||(t[32]=(0,s.Lk)("div",{class:"field-left"}," Reference(s): ",-1)),(0,s.Lk)("div",Xn,["examples"===e.editingField?((0,s.uX)(),(0,s.CE)(s.FK,{key:0},[(0,s.Lk)("div",Un,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(e.examples,((t,i)=>((0,s.uX)(),(0,s.CE)("span",{key:i,class:"tag"},[(0,s.eW)((0,u.v_)(t)+" ",1),(0,s.Lk)("i",{class:"tag-remove",onClick:t=>r.removeExample(e,i)},"×",8,Gn)])))),128)),e.examples.length<3?(0,s.bo)(((0,s.uX)(),(0,s.CE)("input",{key:0,"onUpdate:modelValue":t[15]||(t[15]=e=>o.newExample=e),class:"tag-input",placeholder:"Type & Enter to add",onKeyup:(0,n.jR)((t=>r.addExample(e)),["enter"])},null,40,Fn)),[[n.Jo,o.newExample]]):(0,s.Q3)("",!0)]),(0,s.Lk)("img",{src:o.CheckIcon,class:"icon-check",onClick:t=>r.saveExamples(e),alt:"save"},null,8,Pn)],64)):((0,s.uX)(),(0,s.CE)(s.FK,{key:1},[(0,s.Lk)("div",Vn,[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(e.examples,((e,t)=>((0,s.uX)(),(0,s.CE)("span",{key:t,class:"tag"},(0,u.v_)(e),1)))),128))]),(0,s.Lk)("img",{src:o.ReviseIcon,class:"icon-pencil",onClick:(0,n.D$)((t=>r.startFieldEdit(e,"examples")),["stop"]),alt:"edit"},null,8,Dn)],64))])])])):(0,s.Q3)("",!0)])))),128))]),(0,s.Lk)("div",On,[o.addingConstruct?((0,s.uX)(),(0,s.CE)("div",Hn,[(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":t[17]||(t[17]=e=>o.newC.name=e),placeholder:"Name",class:"field-input"},null,512),[[n.Jo,o.newC.name]]),(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":t[18]||(t[18]=e=>o.newC.definition=e),placeholder:"Definition",class:"field-input"},null,512),[[n.Jo,o.newC.definition]]),(0,s.bo)((0,s.Lk)("input",{"onUpdate:modelValue":t[19]||(t[19]=e=>o.newC.examplesStr=e),placeholder:"Examples (comma-separated)",class:"field-input"},null,512),[[n.Jo,o.newC.examplesStr]]),(0,s.Lk)("div",Kn,[(0,s.Lk)("button",{onClick:t[20]||(t[20]=(...e)=>r.createConstruct&&r.createConstruct(...e)),class:"btn-small"},"Create"),(0,s.Lk)("button",{onClick:t[21]||(t[21]=(...e)=>r.cancelCreate&&r.cancelCreate(...e)),class:"btn-small"},"Cancel")])])):((0,s.uX)(),(0,s.CE)("button",{key:0,onClick:t[16]||(t[16]=e=>o.addingConstruct=!0),class:"btn-add"},"＋ Add Construct"))])])])):(0,s.Q3)("",!0),(0,s.Lk)("div",Wn,[(0,s.Lk)("div",jn,[(0,s.Lk)("button",{disabled:!r.canStartVisualise,onClick:t[22]||(t[22]=(...e)=>r.startVisualise&&r.startVisualise(...e)),class:"btn-next",onMouseenter:t[23]||(t[23]=e=>o.showTooltip=!r.canStartVisualise),onMouseleave:t[24]||(t[24]=e=>o.showTooltip=!1)}," Start visualise ",40,Qn),o.showTooltip?((0,s.uX)(),(0,s.CE)("div",Yn," One or more of the constructs that you created does not have any examples. Please recheck the list of constructs! ")):(0,s.Q3)("",!0)])]),(0,s.bF)(l)])}i(3215),i(670);var Bn=i.p+"img/close.9c522561.svg",Zn={name:"EntityConstructPage",components:{MemoWidget:Xt},data(){return{userId:"",userConfirmed:!1,txtFile:null,userNotExist:!1,uploadInfo:"",uploaded:!1,entities:[],constructs:[],entityEditingId:null,entityNewName:"",addingConstruct:!1,newC:{name:"",definition:"",examplesStr:""},backup:{},newExample:"",ReviseIcon:bi,CheckIcon:Ei,DeleteIcon:Gt,ColorIcon:Ut,PreviousIcon:et,NextIcon:tt,CloseIcon:Bn,pageSize:20,currentPage:1,showTooltip:!1,researchOverview:"",savingOverview:!1}},computed:{sortedEntities(){return this.entities.slice().sort(((e,t)=>e.sentenceIndex!==t.sentenceIndex?e.sentenceIndex-t.sentenceIndex:(e.position||0)-(t.position||0)))},pagedEntities(){const e=(this.currentPage-1)*this.pageSize;return this.sortedEntities.slice(e,e+this.pageSize)},stripedEntities(){let e=!1,t=null;const i=[];this.pagedEntities.forEach((e=>{e.sentence!==t?(i.push([e]),t=e.sentence):i[i.length-1].push(e)})),i.forEach((e=>{e.sort(((e,t)=>(e.position||0)-(t.position||0)))}));const n=[];return i.forEach((t=>{e=!e,t.forEach(((i,s)=>{i._stripe=e,i._showSentence=0===s,i._rowspan=t.length,n.push(i)}))})),n},pageCount(){return Math.ceil(this.entities.length/this.pageSize)||1},canStartVisualise(){return 0!==this.constructs.length&&this.constructs.every((e=>{const t=Array.isArray(e.examples)?e.examples:[];return t.length>=1&&t.length<=3}))}},watch:{currentPage(){this.lastSentence=null,this.stripe=!1},pageSize(){this.currentPage=1,this.lastSentence=null,this.stripe=!1}},methods:{initUser(){localStorage.setItem("userId",this.userId),this.userConfirmed=!0,this.fetchConstructs()},onFileChange(e){this.txtFile=e.target.files[0]||null,this.uploadInfo="",this.uploaded=!1,this.entities=[]},async uploadEntities(){if(!this.txtFile)return;this.uploadInfo="Extracting...",this.userNotExist=!1,Li().start(),console.log(this.researchOverview);const e=await this.txtFile.text();try{const{data:t}=await H.A.post(`${W.baseURL}/api/upload_entities/`,{text:e,user_id:Number(localStorage.getItem("userId")),overview:this.researchOverview});console.log("data:",t);const i=t.sentences.reduce(((e,t)=>e+t.entities.length),0);this.entities=t.sentences.flatMap(((e,t)=>0===e.entities.length?[{id:`placeholder-${t}`,name:"-",sentence:e.sentence,sentenceIndex:e.line_number,construct_id:null,_oldConstructId:null,placeholder:!0}]:e.entities.map(((t,i)=>({id:t.id,name:t.name,sentence:e.sentence,sentenceIndex:e.line_number,position:i,construct_id:null,_oldConstructId:null,placeholder:!1}))))),this.uploadInfo=`Extracted ${i} indicators.`,this.uploaded=!0}catch(t){if("User not found."===t.response.data?.error)return this.userNotExist=!0,void(this.uploadInfo="");this.uploadInfo="Error: "+(t.response?.data?.error||t.message)}finally{Li().done()}},async fetchConstructs(){this.userNotExist=!1;try{const{data:e}=await H.A.get(`${W.baseURL}/api/constructs/all/${localStorage.getItem("userId")}/`);this.constructs=e.constructs.map((e=>({...e,examples:e.examples||[],examplesStr:e.examples||[],editing:!1,expanded:!1,showPicker:!1})))}catch(e){if("User not found."===e.response.data?.error)return void(this.userNotExist=!0);console.error("fetchConstructs failed:",e)}},async assignConstruct(e){if(e.placeholder)return;const t=e.construct_id,i=e._oldConstructId;try{if(await H.A.post(`${W.baseURL}/api/constructs/assign/`,{user_id:Number(localStorage.getItem("userId")),entity_id:e.id,construct_id:t}),e.assigned=!0,i&&i!==t){const t=this.constructs.find((e=>e.id===i));t&&(t.examples=t.examples.filter((t=>t!==e.name)),await H.A.post(`${W.baseURL}/api/constructs/update/${t.id}/`,{examples:t.examples}))}const n=this.constructs.find((e=>e.id===t));n&&!n.examples.includes(e.name)&&n.examples.length<3&&(n.examples.push(e.name),await H.A.post(`${W.baseURL}/api/constructs/update/${n.id}/`,{examples:n.examples})),e._oldConstructId=t}catch(n){console.error("Assign failed:",n)}},async createConstruct(){const e=this.newC.name.trim(),t=this.newC.definition.trim();if(!e||!t){const e="Please fill in both Name and Definition before creating.";return this.$toast?this.$toast.error(e):alert(e)}try{await H.A.post(`${W.baseURL}/api/upload_constructs/`,{user_id:Number(localStorage.getItem("userId")),constructs:[{name:this.newC.name,definition:this.newC.definition,examples:this.newC.examplesStr.split(",").map((e=>e.trim())).filter((e=>e))}]}),this.addingConstruct=!1,this.newC={name:"",definition:"",examplesStr:""},await this.fetchConstructs()}catch(i){console.error("Create construct failed:",i)}},cancelCreate(){this.addingConstruct=!1,this.newC={name:"",definition:"",examplesStr:""}},toggleExpand(e){e.expanded=!e.expanded,e.expanded||(e.editingField=null)},startFieldEdit(e,t){e.editingField=t,this.newExample=""},addExample(e){const t=this.newExample.trim();if(t){if(e.examples.length>=3){const e="You can only add up to 3 examples";return this.$toast?this.$toast.error(e):alert(e)}e.examples.push(t),this.newExample=""}},removeExample(e,t){e.examples.splice(t,1)},cancelField(e){delete e.editingField},async saveExamples(e){const t=this.newExample.trim();t&&(e.examples.push(t),this.newExample=""),await this.saveField(e,"examples")},async saveField(e,t){delete e.editingField;const i={name:e.name,definition:e.definition,examples:e.examples};await H.A.post(`${W.baseURL}/api/constructs/update/${e.id}/`,{[t]:i[t]})},async doDelete(e){await H.A.post(`${W.baseURL}/api/constructs/delete/${e}/`),this.fetchConstructs()},async startVisualise(){const e=Number(localStorage.getItem("userId"));if(!e)return alert("Missing user ID");Li().start();try{await H.A.post(`${W.baseURL}/api/map_constructs/`,{user_id:e,force:!0}),Li().set(.25),await H.A.post(`${W.baseURL}/api/extract_causals/`,{user_id:e}),Li().set(.5),await H.A.post(`${W.baseURL}/api/auto_entity_resolution/`,{user_id:e}),Li().set(.75),await H.A.get(`${W.baseURL}/api/import-data/`,{params:{user_id:e}}),Li().done(),window.confirm("All processing steps completed! Proceed into the system home page?")&&this.$router.push({name:"HomePage"})}catch(t){Li().done(),console.error(t),alert("Processing failed: "+(t.response?.data?.message||t.message))}},autoGrow(e){const t=e.target;t.style.height="auto",t.style.height=t.scrollHeight+"px"},async updateColor(e){e.showPicker=!1;try{await H.A.post(`${W.baseURL}/api/constructs/update/${e.id}/`,{color:e.color}),e.showPicker=!1}catch(t){console.error("保存颜色失败",t),this.$toast&&this.$toast.error("Failed to save color")}},prevPage(){this.currentPage>1&&this.currentPage--},nextPage(){this.currentPage<this.pageCount&&this.currentPage++},isAlternate(e,t){return 0===t?(this.lastSentence=e.sentence,this.stripe=!1):e.sentence!==this.lastSentence&&(this.stripe=!this.stripe,this.lastSentence=e.sentence),this.stripe},onSentenceMouseUp(){if(!this.entityEditingId)return;const e=window.getSelection().toString().trim();e&&(this.entityNewName=e),window.getSelection().removeAllRanges()},startEntityEdit(e){this.entityEditingId=e.id,this.entityNewName=e.name},cancelEntityEdit(){this.entityEditingId=null,this.entityNewName=""},async saveEntityName(e){const t=this.entityNewName.trim();try{await H.A.post(`${W.baseURL}/api/entity/update_entity_name/`,{entity_id:e.id,new_name:t});const i=this.entities.find((t=>t.id===e.id));i&&(i.name=t),e.name=t}catch(i){console.error("Rename failed:",i),alert(i.response?.data?.error||"Failed to rename entity")}finally{this.cancelEntityEdit()}},async onDeleteEntity(e){if(window.confirm(`Are you sure you want to delete “${e.name}”?`))try{await H.A.post(`${W.baseURL}/api/entity/delete_entity/`,{entity_id:e.id,user_id:Number(localStorage.getItem("userId"))}),this.entities=this.entities.filter((t=>t.id!==e.id)),this.$toast?this.$toast.success("Entity deleted"):console.log("Entity deleted")}catch(t){console.error("Delete failed:",t);const e=t.response?.data?.error||t.message;this.$toast?this.$toast.error(`Delete failed: ${e}`):alert(`Delete failed: ${e}`)}},async registerUser(){const e="user_"+Math.random().toString(36).slice(2,10),t=`${e}@example.com`;try{const{data:i}=await H.A.post(`${W.baseURL}/api/user/create/`,{username:e,email:t});this.userId=i.user_id,localStorage.setItem("userId",i.user_id),this.userConfirmed=!0,this.fetchConstructs(),alert(`Registered successfully!\nYour user ID is ${i.user_id}`)}catch(i){console.error("Register failed:",i),alert(i.response?.data?.error||"Registration failed. Please try again.")}},escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},highlightSentence(e){const t=e.sentence||"",i=e.name||"";if(!i)return t;const n=new RegExp(`(${this.escapeRegExp(i)})`,"gi");return t.replace(n,"<strong>$1</strong>")},saveResearchOverview(){alert("Overview saved successfully!")}},mounted(){const e=localStorage.getItem("userId");e&&(this.userId=e,this.initUser())}};const qn=(0,l.A)(Zn,[["render",Jn],["__scopeId","data-v-dd9f0946"]]);var es=qn;const ts=[{path:"/home",name:"HomePage",component:zi},{path:"/main",name:"Main",component:Te},{path:"/node-view",name:"NodeView",component:qe},{path:"/theory-view",name:"TheoryView",component:De},{path:"/",name:"EntityConstruct",component:es}],is=(0,h.aE)({history:(0,h.Bt)(),routes:ts});var ns=is;const ss=(0,n.Ef)(d);ss.use(ns),ss.mount("#app")},6883:function(e,t,i){e.exports=i.p+"img/add.5ebf2f81.svg"},6023:function(e,t,i){e.exports=i.p+"img/delete.055fddcd.svg"}},t={};function i(n){var s=t[n];if(void 0!==s)return s.exports;var a=t[n]={exports:{}};return e[n].call(a.exports,a,a.exports,i),a.exports}i.m=e,function(){var e=[];i.O=function(t,n,s,a){if(!n){var o=1/0;for(d=0;d<e.length;d++){n=e[d][0],s=e[d][1],a=e[d][2];for(var r=!0,l=0;l<n.length;l++)(!1&a||o>=a)&&Object.keys(i.O).every((function(e){return i.O[e](n[l])}))?n.splice(l--,1):(r=!1,a<o&&(o=a));if(r){e.splice(d--,1);var c=s();void 0!==c&&(t=c)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[n,s,a]}}(),function(){i.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return i.d(t,{a:t}),t}}(),function(){i.d=function(e,t){for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}}(),function(){i.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){i.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){i.p="/static/"}(),function(){var e={524:0};i.O.j=function(t){return 0===e[t]};var t=function(t,n){var s,a,o=n[0],r=n[1],l=n[2],c=0;if(o.some((function(t){return 0!==e[t]}))){for(s in r)i.o(r,s)&&(i.m[s]=r[s]);if(l)var d=l(i)}for(t&&t(n);c<o.length;c++)a=o[c],i.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return i.O(d)},n=self["webpackChunkvisualization_frontend"]=self["webpackChunkvisualization_frontend"]||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))}();var n=i.O(void 0,[504],(function(){return i(8880)}));n=i.O(n)})();